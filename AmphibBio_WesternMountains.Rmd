---
title: "Amphibian_Biology"
author: "MThompson"
date: "2024-03-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries


```{r Libraries}

list.of.packages <- c(
  "stringr",
  "here",
  "terra",
  "future",
  "class",
  "reshape",
  "ggplot2",
  "sf",
  "XML",
  "exiftoolr",
  "curl",
  "RCurl",
  "httr",
  "ncdf4",
  "future",
  "rsi",
  "rstac",
  "doParallel",
  "usethis",
  "RColorBrewer",
  "dismo",
  "randomForest",
  "SSDM"
)

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]

if(length(new.packages) > 0){
  install.packages(new.packages, dep=TRUE)
}

#loading packages
for(package.i in list.of.packages){
  suppressPackageStartupMessages(
    library(
      package.i, 
      character.only = TRUE
    )
  )
}

#Developer version needed
#install.packages("terra", repos = "https://rspatial.r-universe.dev")
#library(terra)

# Local
install.packages(paste0(here("Inputs","ClimateNA"),"/ClimateNAr_1.2.0.zip"),
                 repos = NULL,
                 type = "win.binary")
library(ClimateNAr)
n.cores <- future::availableCores() - 1

```

## Spatial data


## EcoZones and BEC polygons processing


```{r spatial_dat, echo=FALSE}

# Pull in Biogeoclimatic spatial info from BC and Yukon
BEC1 <- vect(paste0(here("Inputs","Shapefiles"),
                    "/BEC_POLY_polygon.shp"))
BEC2 <- vect(paste0(here("Inputs","Shapefiles"),
                    "/BEC_POLY_polygon.shp"))
BEC3 <- vect(paste0(here("Inputs","Shapefiles"),
                    "/YukonBEC_Vect.shp"))

EcoZone <- vect(paste0(here("Inputs","Shapefiles"),
                       "/Chapter_EcoZone.shp"))

EcoZone <- terra::project(EcoZone,
                          "EPSG:32610")


BEC3 <- project(BEC3,
                EcoZone)
BEC3 <- mask(BEC3,
             EcoZone)
BEC3 <- crop(BEC3,
             EcoZone)

writeVector(BEC3,
            paste0(here("Inputs","Shapefiles"),
                   "/YukonBEC_Vect_EcoZone2.shp"),
            overwrite=TRUE)

BEC2 <- project(BEC2,
                EcoZone)
BEC2 <- mask(BEC2,
             EcoZone)
BEC2 <- crop(BEC2,
             EcoZone)

writeVector(BEC2,
            paste0(here("Inputs","Shapefiles"),
                   "/BC_BEC_Vect_EcoZone.shp"),
            overwrite=TRUE)

# To QGIS to fin the mapping
#BECx <- merge(BEC2,BEC3) 

# Clip Canada freshwater
# Source: https://open.canada.ca/data/en/dataset/d0cdef71-9343-46c3-b2e7-c1ded5907686

Freshwater <- vect(paste0(here(here("Inputs","Shapefiles")),
                          "/lhy_000c16a_e.shp"))
Freshwater <- project(Freshwater,
                      "EPSG:32610")
Freshwater <- crop(Freshwater,
                   EcoZone)

writeVector(Freshwater,
            paste0(here("Inputs","Shapefiles"),
                   "/Freshwater_Gov.shp"),
            overwrite=TRUE)

#########################################
# Convert amphibian records to shapefiles
# read coordinates with getKMLcoordinates()

Amac <- st_read(paste0(here("Inputs","Shapefiles","AmphibiaWeb_data"),
                          "/Amacro.kml"))
Amac <- vect(Amac)
writeVector(Amac,
            paste0(here("Inputs","Shapefiles","AmphibiaWeb_data"),
                       "/Amacro.shp"),
            overwrite=TRUE)

# Calling in data from gpx

gpx_parsed <- htmlTreeParse(file = paste0(here("Inputs","AmphibianLocations"),
                                          "/Lawyers_Wildlife_MDT.gpx"),
                            useInternalNodes = TRUE)

coords <- xpathSApply(doc = gpx_parsed, path = "//wpt", fun = xmlAttrs)
elevation <- xpathSApply(doc = gpx_parsed, path = "//wpt/ele", fun = xmlValue)

df <- data.frame(
  lat = as.numeric(coords["lat", ]),
  lon = as.numeric(coords["lon", ]),
  elevation = as.numeric(elevation)
)

############################################
# Obtaining coordinates from image records

install_exiftool()
file_names <- list.files(here("Inputs","AmphibianLocations"),
                         pattern = "*.jpg", full.names=TRUE)

figls <- list()

for(i in 1:length(file_names)){
  figls[[i]] <- exif_read(path = file_names[i],
                        tags=c("GPSDateStamp",
                               "GPSLatitude",
                               "GPSLongitude"))
}

# Some images do not have the data
# 1,12 miss Date, lat, lon
figls[[1]][,c(2:4)] = NA
colnames(figls[[1]]) = c("SourceFile",
                         "GPSDateStamp",
                         "GPSLatitude",
                         "GPSLongitude")
figls[[12]][,c(2:4)] = NA
colnames(figls[[12]]) = c("SourceFile",
                          "GPSDateStamp",
                          "GPSLatitude",
                          "GPSLongitude")

# 6:8,10, miss date
figls[[6]][,c(3:4)] = figls[[6]][,c(2:3)]
figls[[6]][,2] = NA
colnames(figls[[6]]) = c("SourceFile",
                         "GPSDateStamp",
                         "GPSLatitude",
                         "GPSLongitude")

figls[[7]][,c(3:4)] = figls[[7]][,c(2:3)]
figls[[7]][,2] = NA
colnames(figls[[7]]) = c("SourceFile",
                         "GPSDateStamp",
                         "GPSLatitude",
                         "GPSLongitude")
figls[[8]][,c(3:4)] = figls[[8]][,c(2:3)]
figls[[8]][,2] = NA
colnames(figls[[8]]) = c("SourceFile",
                         "GPSDateStamp",
                         "GPSLatitude",
                         "GPSLongitude")

figls[[10]][,c(3:4)] = figls[[10]][,c(2:3)]
figls[[10]][,2] = NA
colnames(figls[[10]]) = c("SourceFile",
                         "GPSDateStamp",
                         "GPSLatitude",
                         "GPSLongitude")

fig_df <- do.call(rbind.data.frame, figls)

fig_df[12,2] = "2023:6:13"
fig_df[12,3] = "57.385949"
fig_df[12,4] = "-127.245555"

# Palmer toad
fig_df[1,2] = "2022:9:10"
fig_df[1,3] = "57.346881"
fig_df[1,4] = "-127.148412"

figls[[i]] <- exif_read(path = file_names[i],
                        tags=c("GPSDateStamp",
                               "GPSLatitude",
                               "GPSLongitude"))
fig_df[6,2] = "2023:6:13"

fig_df[1] <- list.files(here("Amphibian Database_MDT","New"),
                        pattern = "*.jpg")
fig_df[c(6:8),2] <- "2023:06:26"
fig_df[10,2] <- "2023:06:27"
fig_df[,3] <- as.numeric(fig_df[,3])
fig_df[,4] <- as.numeric(fig_df[,4])
fig_df$species <- c("ANBO"
                    ,"ANBO",
                    "ANBO",
                    "ANBO",
                    "ANBO",
                    "RALU",
                    "RALU",
                    "RALU",
                    "ANBO",
                    "RALU",
                    "ANBO",
                    "RALU")
fig_df$stage <- c("adult",
                  "tadpole",
                  "tadpole",
                  "tadpole",
                  "tadpole",
                  "adult",
                  "adult",
                  "adult",
                  "tadpole",
                  "adult",
                  "adult",
                  "adult")

fig_df <- as.data.frame(fig_df)

Amphibians <- terra::vect(fig_df,geom=c("GPSLongitude",
                                 "GPSLatitude"),
                   crs="epsg:32610")

Amphibians <- project(Amphibians, "epsg:32610")

writeVector(Amphibians,
            paste0(here("Inputs","AmphibianLocations"),
                   "/Amphibians_Layers.shp"),
            overwrite=TRUE)
```

# Obtain the Canada DEM

```{r DEM, echo=FALSE}


###############################################
# Canada DEM download for distribution models
Sheets <- c("082",
            "083",
            "084",
            "092",
            "093",
            "094",
            "095",
            "096",
            "104",
            "105",
            "106",
            "114",
            "115",
            "116",
            "117")


for(i in 1:length(Sheets)){
  URL = paste0("ftp.maps.canada.ca/pub/nrcan_rncan/elevation/cdem_mnec/"
               ,Sheets[i],
               "/")
  filenames <- getURL(URL,
                      dirlistonly = TRUE)
  files <- unlist(strsplit(filenames,
                           '\r\n'))
  files_full <- paste0(here("DEM","CDEM"),
                       "/",
                       files)
  
  for(r in 1:length(files_full)){
    download.file(paste0(URL,files[r]),
                  destfile = files_full[r],
                  method="libcurl")
  }
  }

# Extract the Zipfiles:
zipfiles <- dir(here("DEM","CDEM"),
                pattern="\\D_tif.zip$",
                full.names=TRUE)

for(i in 1:length(zipfiles)){
    unzip(zipfiles[i],
          exdir = here("DEM","CDEM"),
          overwrite = FALSE)
}

# Hijmans described:
# https://stackoverflow.com/
# 70946870

DEM_dir <- dir(here("Inputs","Rasters","CDEM"),
                 full.names=TRUE,
                 pattern="cdem_dem_\\d{2,}\\D.tif$")

DEM_rasts <- vrt(DEM_dir)

# Run each ecozone (1-3) separately
EcoZonet <- project(EcoZone,
                    DEM_rasts)
DEM_rasts1 <- crop(DEM_rasts,
                   EcoZonet[1,])
DEM_rasts2 <- crop(DEM_rasts,
                   EcoZonet[2,])
DEM_rasts3 <- crop(DEM_rasts,
                   EcoZonet[3,])

newcrs="epsg:3005"
n.cores <- future::availableCores() - 1

DEM_rasts1 <- project(DEM_rasts1,
                      newcrs,
                      method="cubicspline",
                      filename=paste0(here("Inputs","Rasters","CDEM"),
                                      "/DEM_rasts1.tif"),
                      threads=n.cores,
                      overwrite=TRUE,
                      res=20
)

DEM_rasts2 <- project(DEM_rasts2,
                      newcrs,
                      method="cubicspline",
                      filename=paste0(here("Inputs","Rasters","CDEM"),
                                      "/DEM_rasts2.tif"),
                      threads=n.cores,
                      overwrite=TRUE,
                      res=20
)

DEM_rasts3 <- project(DEM_rasts3,
                      newcrs,
                      method="cubicspline",
                      filename=paste0(here("Inputs","Rasters","CDEM"),
                                      "/DEM_rasts3.tif"),
                      threads=n.cores,
                      overwrite=TRUE,
                      res=20
)

# Apply approach
#f <- lapply(DEM_rasts,
#            terra::rast)
#f <- sprc(f)
#f.mosaic <- mosaic(f, fun="mean")

# I ran m and f.mosaic above using
# the slow and fast methods respectively.
# This created a southern (f.mosaic) and
# northern part. I kept them apart to
# keep the projection processing manageable.

# Simplify to remove inner lines for mask
Ecodis <- aggregate(EcoZone)

DEM_rastsm1 <- mask(DEM_rasts1,
                    Ecodis,
                    threads=n.cores)

writeRaster(DEM_rastsm1,
            paste0(here("Inputs","Rasters","CDEM"),
                   "/DEM_rastsm1.tif"),
            overwrite=TRUE)

DEM_rastsm2 <- mask(DEM_rasts2,
                    Ecodis,
                    threads=n.cores)

writeRaster(DEM_rastsm2,
            paste0(here("Inputs","Rasters","CDEM"),
                   "/DEM_rastsm2.tif"),
            overwrite=TRUE)

DEM_rastsm3 <- mask(DEM_rasts3,
                    Ecodis,
                    threads=n.cores)

writeRaster(DEM_rastsm3,
            paste0(here("Inputs","Rasters","CDEM"),
                   "/DEM_rastsm3.tif"),
            overwrite=TRUE)

DEM_rastsm1 <- rast(paste0(here("Inputs","Rasters","CDEM"),
                           "/DEM_rastsm1.tif"))

DEM_rastsm2 <- rast(paste0(here("Inputs","Rasters","CDEM"),
                           "/DEM_rastsm2.tif"))

DEM_rastsm3 <- rast(paste0(here("Inputs","Rasters","CDEM"),
                           "/DEM_rastsm3.tif"))

DEM_rastsm123 <- dir(here("Inputs","Rasters","CDEM"),
                     pattern="DEM_rastsm\\d.tif$",
                     full.names=TRUE)

v <- vrt(DEM_rastsm123)
CDEM_full <- writeRaster(v,
                         paste0(here("Inputs","Rasters","CDEM"),
                                "/CDEM_total.tif"),
                         overwrite=TRUE)

CDEM_full <- rast(paste0(here("Inputs","Rasters","CDEM"),
                         "/CDEM_total.tif"))

EcoZone <- project(EcoZone,
                   CDEM_full)

## The challenge: Using UTM conversions
## from far northern extents do not
## always proceed well in reprojection.
## I had to iterate through projections
## to bring all into one projection.

# Patchwork fix:
#105I-J, 117, 106G, and 095L missed

d095L <- rast(DEM_dir[108])
d095L <- project(d095L,
                 "EPSG:3005",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d095L.tif")
                 )

d105I <- rast(DEM_dir[151])
d105I <- project(d105I,
                 "EPSG:3005",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d105I.tif")
)

d106G <- rast(DEM_dir[165])
d106G <- project(d106G,
                 "EPSG:3005",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d106G.tif")
                 )

d117A <- rast(DEM_dir[202])
d117A <- project(d117A,
                 "EPSG:32610",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d117A.tif")
                 )

d117A2 <- project(d117A,
                  "EPSG:3005",
                  threads=n.cores,
                  res=20,
                  filename=paste0(here("Inputs","Rasters","CDEM"),
                                  "/d117A2.tif")
)


d117B <- rast(DEM_dir[203])
d117B <- project(d117B,
                 "EPSG:32610",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d117B.tif")
                 )
d117B2 <- project(d117B,
                  "EPSG:3005",
                  threads=n.cores,
                  res=20,
                  filename=paste0(here("Inputs","Rasters","CDEM"),
                                  "/d117B2.tif")
)

d117C <- rast(DEM_dir[204])
d117C <- project(d117C,
                 "EPSG:32610",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d117C.tif")
                 )
d117C2 <- project(d117C,
                  "EPSG:3005",
                  threads=n.cores,
                  res=20,
                  filename=paste0(here("Inputs","Rasters","CDEM"),
                                  "/d117C2.tif")
)

d117D <- rast(DEM_dir[205])
d117D <- project(d117D,
                 "EPSG:32610",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d117D.tif")
                 )
d117D2 <- project(d117D,
                 "EPSG:3005",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d117D2.tif")
)

d103P <- rast(paste0(here("Inputs","Rasters","CDEM",
                          "cdem_dem_103P_tif"),
                     "/cdem_dem_103P.tif"))

d103P <- project(d103P,
                 "EPSG:32610",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d103P.tif")
                 )

d103P <- project(d103P,
                 "EPSG:3005",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d103P_3005.tif")
)

d103P <- rast(paste0(here("Inputs","Rasters","CDEM"),
                     "/d103P_3005.tif"))

dDEMs <- c(paste0(here("Inputs","Rasters","CDEM"),
                  "/d095L.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d105I.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d106G.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d117A2.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d117B2.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d117C2.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d117D2.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d103P_3005.tif")
           )

v <- vrt(dDEMs)
v <- mask(v,
          Ecodis,
          threads=n.cores)

newDEM_rasts <- writeRaster(v,
                         paste0(here("Inputs","Rasters","CDEM"),
                                "/newDEM_rasts.tif"),
                         overwrite=TRUE)

newDEM_rasts <- rast(paste0(here("Inputs","Rasters","CDEM"),
                            "/newDEM_rasts.tif"))

DEM_tot_new <- c(dir(here("Inputs","Rasters","CDEM"),
                     pattern="CDEM_total.tif$",
                     full.names=TRUE),
                 dir(here("Inputs","Rasters","CDEM"),
                     pattern="newDEM_rasts.tif$",
                     full.names=TRUE)
                 )

v <- vrt(DEM_tot_new)

CDEM_Total <- writeRaster(v,
                         paste0(here("Inputs","Rasters","CDEM"),
                                "/CDEM_Total2.tif"),
                         overwrite=TRUE)

CDEM_Total <- rast(paste0(here("Inputs","Rasters","CDEM"),
                         "/CDEM_Total2.tif"))

EcoZonet <- project(EcoZone,
                    CDEM_Total)

#Taiga = 3, montane=2, boreal=1
CDEM_taiga <- mask(CDEM_Total,
                   EcoZonet[3,],
                   threads=n.cores)
CDEM_boreal <- mask(CDEM_Total,
                    EcoZonet[1,],
                    threads=n.cores)
CDEM_montane <- mask(CDEM_Total,
                     EcoZonet[2,],
                     threads=n.cores)

writeRaster(CDEM_taiga,
            paste0(here("Inputs","Rasters","CDEM"),
                   "/CDEM_taiga.tif"),
                   overwrite=TRUE)

writeRaster(CDEM_boreal,
            paste0(here("Inputs","Rasters","CDEM"),
                   "/CDEM_boreal.tif"),
                   overwrite=TRUE)

writeRaster(CDEM_montane,
            paste0(here("Inputs","Rasters","CDEM"),
                   "/CDEM_montane.tif"),
                   overwrite=TRUE)

CDEM_taiga <- rast(paste0(here("Inputs","Rasters","CDEM"),
                          "/CDEM_taiga.tif"))
CDEM_boreal <- rast(paste0(here("Inputs","Rasters","CDEM"),
                          "/CDEM_boreal.tif"))
CDEM_montane <- rast(paste0(here("Inputs","Rasters","CDEM"),
                          "/CDEM_montane.tif"))

## Last few -

URL = paste0("ftp.maps.canada.ca/pub/nrcan_rncan/elevation/cdem_mnec/"
              ,107,
              "/")

filenames <- getURL(URL,
                     dirlistonly = TRUE)

files <- unlist(strsplit(filenames,
                          '\r\n'))
files_full <- paste0(here("DEM","CDEM"),
                      "/",
                      files)
 
for(r in 1:length(files_full)){
    download.file(paste0(URL,files[r]),
                  destfile = files_full[r],
                  method="libcurl")
}

d107B <- rast(paste0(here("DEM","CDEM"),"/cdem_dem_107B.tif"))
d107B <- project(d107B, crs(EcoZone),
                 threads=n.cores,
                 res=250,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d107B.tif"), overwrite=TRUE
                 )

d106M <- rast(DEM_dir[172])
d106M <- project(d106M,
                 crs(EcoZone),
                 threads=n.cores,
                 res=250,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d106M.tif"), overwrite=TRUE
                 )



```


# rsi Data

Search for NDVI data (MODIS Vegetation Indices 16-Day (250m) https://planetarycomputer.microsoft.com/dataset/modis-13Q1-061) for 2023 over the EcoZone.

```{r rsi, echo=FALSE}

# Aggregate for single
EcoZonea <- aggregate(EcoZone)
writeVector(EcoZonea,
            paste0(here("Inputs","Shapefiles"),
                   "/EcoZoneagg.shp"),
            overwrite=TRUE)

EcoZonea <- project(EcoZonea, "epsg:4326")
EcoZonea_ext <- as.numeric(as.matrix(ext(EcoZonea)))

EcoZone1 <- EcoZone[1]
writeVector(EcoZone1,
            paste0(here("Inputs","Shapefiles"),
                   "/EcoZone1.shp"),
            overwrite=TRUE)

stac_source <- rstac::stac(
  "https://planetarycomputer.microsoft.com/api/stac/v1"
)

rstac::stac_search(
  q = stac_source,
  collections = "modis-13Q1-061",
  bbox = c(EcoZonea_ext[1],
           EcoZonea_ext[2],
           EcoZonea_ext[3],
           EcoZonea_ext[4]),
  datetime = "2023-05-15/2023-08-31",
  limit = 999
) |> 
  rstac::get_request()

EcoZonea_sf <- sf::st_as_sf(EcoZonea)

Modis_VI <- get_stac_data(
  EcoZonea_sf,
  start_date = "2023-05-15",
  end_date = "2023-08-31",
  stac_source="https://planetarycomputer.microsoft.com/api/stac/v1",
  collection = "modis-13Q1-061",
  asset_names = "250m_16_days_EVI",
  composite_function=NULL,
  output_filename = paste0(here::here("Outputs","Rasters"),"/MODIS23.tif")
)

Modis_VI <- dir(paste0(here::here("Outputs","Rasters")), full.names=TRUE)
       
# TEST
#xm <- project(rast(Modis_VI[1]), "EPSG:32610", threads=n.cores, res=250)

f <- lapply(Modis_VI,
            terra::rast)

f2 <- lapply(f, function(x) project(x, y = 'epsg:32610', threads=n.cores, res=250))

f3 = Filter(function(r){!all(is.nan(values(r)))}, f2)


my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)
f.mosaic <- do.call(mosaic, f3)
# Stop the parallel backend
stopCluster(my.cluster)

writeRaster(f.mosaic,filename=paste0(here::here("Outputs","Rasters"),
                                     "/MODIS_FULL.tif"), overwrite=TRUE)

MODIS_FULL <- mask(f.mosaic,EcoZone,threads=n.cores)

writeRaster(MODIS_FULL,filename=paste0(here::here("Outputs","Rasters"),
                                     "/MODIS_FULL.tif"), overwrite=TRUE)

##############
# Piece is still missing in northern clip.
# Try again, smaller

EcoZone3 <- EcoZone[3]

EcoZone3 <- sf::st_as_sf(EcoZone3)

Modis_VI <- get_stac_data(
  EcoZone3,
  start_date = "2023-05-15",
  end_date = "2023-08-31",
  stac_source="https://planetarycomputer.microsoft.com/api/stac/v1",
  collection = "modis-13Q1-061",
  asset_names = "250m_16_days_EVI",
  composite_function=NULL,
  output_filename = paste0(here::here("Outputs","Rasters"),"/MODIS_N.tif")
)

Modis_VI_N <- dir(paste0(here::here("Outputs","Rasters")),
                  full.names=TRUE,
                  pattern="MODIS_N_\\d{1,}.tif$")


f <- lapply(Modis_VI_N,
            terra::rast)

f2 <- lapply(f, function(x) project(x, y = 'epsg:32610', threads=n.cores, res=250))
f3 = Filter(function(r){!all(is.nan(values(r)))}, f2)

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)
f.mosaic <- do.call(mosaic, f3)
# Stop the parallel backend
stopCluster(my.cluster)

MODIS_FULL2 <- merge(MODIS_FULL,f.mosaic)

MODIS_FULL <- mask(MODIS_FULL2,EcoZone,threads=n.cores)

writeRaster(MODIS_FULL,filename=paste0(here::here("Outputs","Rasters"),
                                     "/MODIS_FULL.tif"), overwrite=TRUE)


```


# Integrate the rasters


```{r Explan_Rasts, echo=FALSE}

MODIS_FULL <- rast(paste0(here::here("Outputs","Rasters"),
                                     "/MODIS_FULL.tif"))

# Put all these rasters into the inputs
writeRaster(MODIS_FULL,
            filename=paste0(here::here("Inputs",
                                       "Rasters",
                                       "Explanatory"),
                                     "/MODIS_FULL.tif"),
            overwrite=TRUE)


CDEM_Total <- rast(paste0(here("Inputs","Rasters","CDEM"),
                         "/CDEM_Total2.tif"))

LandCov <- rast(paste0(here("Inputs","Rasters","Explanatory"),
                                     "/amph_ecozone_landcover.tif"))

CDEM_Total <- project(CDEM_Total,MODIS_FULL,
                      threads=n.cores,
                      res=250)

writeRaster(CDEM_Total,
            filename=paste0(here::here("Inputs",
                                       "Rasters",
                                       "Explanatory"),
                                     "/CDEM_Total.tif"),
            overwrite=TRUE)

LandCov <-  project(LandCov,
                    MODIS_FULL,
                    threads=n.cores,
                    res=250)
writeRaster(LandCov,
            filename=paste0(here::here("Inputs",
                                       "Rasters",
                                       "Explanatory"),
                                     "/LandCov.tif"),
            overwrite=TRUE)


MODIS_FULL <- rast(paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/MODIS_FULL.tif"))

LandCov <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/LandCov.tif"))

CDEM_Total <- rast(paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_Total.tif"))

# Add the last missing pieces
d106M <- project(d106M,
                 crs(CDEM_Total),
                 threads=n.cores,
                 res=250,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d106M.tif"), overwrite=TRUE)

d107B <- project(d107B,
                 crs(CDEM_Total),
                 threads=n.cores,
                 res=250,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d107B.tif"), overwrite=TRUE)

dDEMs <- c(paste0(here("Inputs","Rasters","CDEM"),
                  "/d106M.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d107B.tif")
           )

v <- vrt(dDEMs)
v <- mask(v,
          EcoZone[3],
          threads=n.cores)

newDEM_rasts <- writeRaster(v,
                         paste0(here("Inputs","Rasters","CDEM"),
                                "/newDEM_rasts.tif"),
                         overwrite=TRUE)

newDEM_rasts <- rast(paste0(here("Inputs","Rasters","CDEM"),
                            "/newDEM_rasts.tif"))

DEM_tot_new <- c(dir(here("Inputs","Rasters","CDEM"),
                     pattern="newDEM_rasts.tif",
                     full.names=TRUE),
                 paste0(here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_Total.tif")
                 )
                 

v <- vrt(DEM_tot_new)

CDEM_Total <- writeRaster(v,
                         paste0(here("Inputs","Rasters","CDEM"),
                                "/CDEM_Total.tif"),
                         overwrite=TRUE)



```


#Climate NA

```{r ClimateNA, echo=FALSE}

CDEM_Total <- rast(paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_Total.tif"))

climbc <- rast(paste0(here("InputFiles"),"/BC80k.asc"))
climbcdf <- as.data.frame(climbc) 

EcoZone <- project(EcoZone,
                   crs(climbc))

CDEM_Total <- project(CDEM_Total,
                       crs(climbc),
                      threads=n.cores)

Boreal <- EcoZone[1] # Boreal
Montane <- EcoZone[2] # Montane
Taiga <- EcoZone[3] # Taiga

#Boreal

CDEM_Total1 <- mask(CDEM_Total, Boreal)
CDEM_Total1 <- crop(CDEM_Total1, Boreal, mask=TRUE)
values(CDEM_Total1) <- as.integer(values(CDEM_Total1))
CDEM_Total1 <- subst(CDEM_Total1, NA, -9999)

writeRaster(CDEM_Total1,
            paste0(here("Outputs","Rasters","Explanatory"),
                         "/CDEM_boreal.asc"),
            NAflag=-9999, overwrite=TRUE)

temp <- readLines(paste0(here("Outputs","Rasters","Explanatory"),
                         "/CDEM_boreal.asc"))

write.table(temp,paste0(here("Outputs","Rasters","Explanatory"),
                         "/CDEM_boreal.asc"),
            row.names=F,
            col.names=F,
            quote=F)

# Montane

CDEM_Total2 <- mask(CDEM_Total, Montane)
CDEM_Total2 <- crop(CDEM_Total2, Montane, mask=TRUE)
values(CDEM_Total2) <- as.integer(values(CDEM_Total2))
CDEM_Total2 <- subst(CDEM_Total2, NA, -9999)

writeRaster(CDEM_Total2,
            paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_montane.asc"),
            NAflag=-9999, overwrite=TRUE)


temp <- readLines(paste0(here("Outputs","Rasters","Explanatory"),
                         "/CDEM_montane.asc"))

write.table(temp,paste0(here("Outputs","Rasters","Explanatory"),
                         "/CDEM_montane.asc"),
            row.names=F,
            col.names=F,
            quote=F)

#Taiga
CDEM_Total3 <- mask(CDEM_Total, Taiga)
CDEM_Total3 <- crop(CDEM_Total3, Taiga, mask=TRUE)
values(Taiga) <- as.integer(values(Taiga))
CDEM_Total3 <- subst(CDEM_Total3, NA, -9999)

writeRaster(CDEM_Total3,
            paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_taiga.asc"),
            NAflag=-9999, overwrite=TRUE)

temp <- readLines(paste0(here("Outputs","Rasters","Explanatory"),
                         "/CDEM_taiga.asc"))

write.table(temp,paste0(here("Outputs","Rasters","Explanatory"),
                         "/CDEM_taiga.asc"),
            row.names=F,
            col.names=F,
            quote=F)


CDEM_boreal <- rast(paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_boreal.asc"))
CDEM_montane <- rast(paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_montane.asc"))
CDEM_taiga <- rast(paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_taiga.asc"))

```

# Predictor Variables: Amphibian Data

```{r Amphib_locs, echo=TRUE, eval=FALSE}

AMMA <- vect(paste0(here("Inputs","AmphibianLocations"),"/AMMA_Total.shp"))
AMMA <- project(AMMA,"EPSG:32610")
AMMA <- crop(AMMA, EcoZone)
  
AMTI <- vect(paste0(here("Inputs","AmphibianLocations"),"/AMTI_Total.shp"))
AMTI <- project(AMTI,"EPSG:32610")
AMTI <- crop(AMTI, EcoZone)

ANBO <- vect(paste0(here("Inputs","AmphibianLocations"),"/ANBO_Total.shp"))
ANBO <- project(ANBO,"EPSG:32610")
ANBO <- crop(ANBO, EcoZone)

RALU <- vect(paste0(here("Inputs","AmphibianLocations"),"/RALU_Total.shp"))
RALU <- project(RALU,"EPSG:32610")
RALU <- crop(RALU, EcoZone)

RASY <- vect(paste0(here("Inputs","AmphibianLocations"),"/RASY_Total.shp"))
RASY <- project(RASY,"EPSG:32610")
RASY <- crop(RASY, EcoZone)

# Buffer the points by 1 km
AMMA_1km <- buffer(AMMA,
                   1000)
AMTI_1km <- buffer(AMTI,
                   1000)
ANBO_1km <- buffer(ANBO,
                   1000)
RALU_1km <- buffer(RALU,
                   1000)
RASY_1km <- buffer(RASY,
                   1000)


```


# Explanatory Variables

Review of variables in Muths et al. (2017) to consider variables for models.

Lucid and Cushman (2020) Northwest Naturalist, 104:281-286
Mean annual minimum air temperature

Derived annual variables:
Directly calculated annual variables:
MAT	 	mean annual temperature (°C),
MWMT 	mean warmest month temperature (°C),
MCMT  mean coldest month temperature (°C),

Derived seasonal variables:
RH_wt		winter relative humidity (%)

3) Monthly variables
Primary monthly variables:
TMN01 – TMN12 	January - December minimum mean temperatures (°C)


```{r, Explanatory_Vars, echo=FALSE}

# Shapefiles
EcoZone <- project(EcoZone,"EPSG:32610")
Boreal <- EcoZone[1] # Boreal
Montane <- EcoZone[2] # Montane
Taiga <- EcoZone[3] # Taiga

CDEM_Total <- rast(paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_Total.tif"))
CDEM_Total <- project(CDEM_Total,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(CDEM_Total) <- "Elev"

writeRaster(CDEM_Total,
            paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_Total.tif"),
            overwrite=TRUE)


CDEM_boreal <- rast(paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_boreal.asc"))
CDEM_boreal <- project(CDEM_boreal,
                       "EPSG:32610",
                      threads=n.cores,
                      filename=paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_boreal.tif"),
                      overwrite=TRUE,
                      res=250)

CDEM_montane <- rast(paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_montane.asc"))
CDEM_montane <- project(CDEM_montane,
                       "EPSG:32610",
                      threads=n.cores,
                      filename=paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_montane.tif"),
                      overwrite=TRUE,
                      res=250)

CDEM_taiga <- rast(paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_taiga.asc"))
CDEM_taiga <- project(CDEM_taiga,
                       "EPSG:32610",
                      threads=n.cores,
                      filename=paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_taiga.tif"),
                      overwrite=TRUE,
                      res=250)

# Roughness
Rough_dem <- terrain(CDEM_Total, "roughness")

names(Rough_dem) <- "Rough"

writeRaster(Rough_dem,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/Rough_dem.tif"),
            overwrite=TRUE)


# Slope
Slope_dem <- terrain(CDEM_Total, "slope")
names(Slope_dem) <- "Slope_vals"
writeRaster(Slope_dem, paste0(here("Inputs","Rasters",
                        "Explanatory"),"/Slope_dem.tif"), overwrite=TRUE)


# aspect
Aspect_dem <- terrain(CDEM_Total, "aspect")
names(Aspect_dem) <- "aspect"
writeRaster(Aspect_dem, paste0(here("Inputs","Rasters",
                        "Explanatory"),"/Aspect_dem.tif"), overwrite=TRUE)


# Slope-Aspect
SA_dem <- Slope_dem*Aspect_dem
names(SA_dem) <- "SA"
writeRaster(Aspect_dem, paste0(here("Inputs","Rasters",
                        "Explanatory"),"/SA_dem.tif"), overwrite=TRUE)



# Climate Variables
# Mean annual temperature
Boreal_MAT <- rast(paste0(here("Outputs",
                              "Rasters",
                              "Explanatory",
                              "CDEM_boreal",
                              "Normal_1991_2020Y"),
                          "/MAT.asc"))

Boreal_MAT <- project(Boreal_MAT,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(Boreal_MAT) <- "MAT"

writeRaster(Boreal_MAT,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/Boreal_MAT.tif"),
            overwrite=TRUE)



Montane_MAT <- rast(paste0(here("Outputs",
                              "Rasters",
                              "Explanatory",
                              "CDEM_montane",
                              "Normal_1991_2020Y"),
                          "/MAT.asc"))

Montane_MAT <- project(Montane_MAT,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(Montane_MAT) <- "MAT"
writeRaster(Montane_MAT,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/Montane_MAT.tif"),
            overwrite=TRUE)


Taiga_MAT <- rast(paste0(here("Outputs",
                              "Rasters",
                              "Explanatory",
                              "CDEM_taiga",
                              "Normal_1991_2020Y"),
                          "/MAT.asc"))

Taiga_MAT <- project(Taiga_MAT,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(Taiga_MAT) <- "MAT"
writeRaster(Taiga_MAT,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/Taiga_MAT.tif"),
            overwrite=TRUE)

# mean coldest month temperature (°C),
# MCMT  

Boreal_MCMT <- rast(paste0(here("Outputs",
                              "Rasters",
                              "Explanatory",
                              "CDEM_boreal",
                              "Normal_1991_2020Y"),
                          "/MCMT.asc"))

Boreal_MCMT <- project(Boreal_MCMT,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(Boreal_MCMT) <- "MCMT"
writeRaster(Boreal_MCMT,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/Boreal_MCMT.tif"),
            overwrite=TRUE)



Montane_MCMT <- rast(paste0(here("Outputs",
                              "Rasters",
                              "Explanatory",
                              "CDEM_montane",
                              "Normal_1991_2020Y"),
                          "/MCMT.asc"))

Montane_MCMT <- project(Montane_MCMT,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(Montane_MCMT) <- "MCMT"
writeRaster(Montane_MCMT,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/Montane_MCMT.tif"),
            overwrite=TRUE)


Taiga_MCMT <- rast(paste0(here("Outputs",
                              "Rasters",
                              "Explanatory",
                              "CDEM_taiga",
                              "Normal_1991_2020Y"),
                          "/MCMT.asc"))

Taiga_MCMT <- project(Taiga_MCMT,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(Taiga_MCMT) <- "MCMT"
writeRaster(Taiga_MCMT,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/Taiga_MCMT.tif"),
            overwrite=TRUE)


## NDVI:

NDVI <- rast(paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/MODIS_FULL.tif"))

NDVI <- project(NDVI,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(NDVI) <- "NDVI"

writeRaster(NDVI,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/NDVI.tif"),
            overwrite=TRUE)

## Land Cover

LandCov <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/LandCov.tif"))

LandCov <- project(LandCov,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(LandCov) <- "LandCov"

writeRaster(LandCov,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/LandCov.tif"),
            overwrite=TRUE)


# CDEM

CDEM_Total <- rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/CDEM_Total.tif"))
CDEM_boreal <-rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/CDEM_boreal.tif"))
CDEM_montane <-rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/CDEM_montane.tif"))
CDEM_taiga <-rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/CDEM_taiga.tif"))

#Roughness
Rough_dem <- rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/Rough_dem.tif"))
Rough_boreal <- crop(Rough_dem,Boreal)
Rough_boreal <- mask(Rough_boreal,Boreal)
Rough_montane <- crop(Rough_dem,Montane)
Rough_montane <- mask(Rough_montane,Montane)
Rough_taiga <- crop(Rough_dem,Taiga)
Rough_taiga <- mask(Rough_taiga,Taiga)

#Slope_Aspect
SA_dem <- rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/SA_dem.tif"))
SA_boreal <- crop(SA_dem,Boreal)
SA_boreal <- mask(SA_boreal,Boreal)

SA_montane <- crop(SA_dem,Montane)
SA_montane <- mask(SA_montane,Montane)

SA_taiga <- crop(SA_dem,Taiga)
SA_taiga <- mask(SA_taiga,Taiga)

#NDVI
NDVI <-rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/NDVI.tif")) 
NDVI_boreal <- crop(NDVI,Boreal)
NDVI_boreal <- mask(NDVI_boreal,Boreal)

NDVI_montane <- crop(NDVI,Montane)
NDVI_montane <- mask(NDVI_montane,Montane)

NDVI_taiga <- crop(NDVI,Taiga)
NDVI_taiga <- mask(NDVI_taiga,Taiga)

#LandCov
LandCov <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/LandCov.tif"))
LandCov_boreal <- crop(LandCov,Boreal)
LandCov_boreal <- mask(LandCov_boreal,Boreal)

LandCov_montane <- crop(LandCov,Montane)
LandCov_montane <- mask(LandCov_montane,Montane)

LandCov_taiga <- crop(LandCov,Taiga)
LandCov_taiga <- mask(LandCov_taiga,Taiga)

# MAT
Boreal_MAT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Boreal_MAT.tif"))
Montane_MAT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Montane_MAT.tif"))
Taiga_MAT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Taiga_MAT.tif"))

# MCMT
Boreal_MCMT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Boreal_MCMT.tif"))

Montane_MCMT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Montane_MCMT.tif"))

Taiga_MCMT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Taiga_MCMT.tif"))

# Some have slightly different origins.
# resample - see:
# https://gis.stackexchange.com/questions/440245

blankras <- NDVI_boreal
blankras[blankras > min(values(blankras),na.rm=TRUE)] <- 1
blankras[blankras < max(values(blankras),na.rm=TRUE)] <- 1

CDEM_boreal <- resample(CDEM_boreal,blankras)
CDEM_boreal <- mask(CDEM_boreal,blankras)

Boreal_MAT  <- resample(Boreal_MAT,blankras)
Boreal_MAT <- mask(Boreal_MAT,blankras)

Boreal_MCMT <- resample(Boreal_MCMT,blankras)
Boreal_MCMT <- mask(Boreal_MCMT,blankras)

SA_boreal <- resample(SA_boreal,blankras)
SA_boreal <- mask(SA_boreal,Rough_boreal)

NDVI_boreal <- resample(NDVI_boreal,blankras)
NDVI_boreal <- mask(NDVI_boreal,blankras)

LandCov_boreal <- resample(LandCov_boreal,blankras)
LandCov_boreal <- mask(LandCov_boreal,blankras)

Sprasts_boreal <- c(CDEM_boreal,
                    Rough_boreal,
                    SA_boreal,
                    NDVI_boreal,
                    LandCov_boreal,
                    Boreal_MAT,
                    Boreal_MCMT
                    )

# Montane

blankras <- NDVI_montane
blankras[blankras > min(values(blankras),na.rm=TRUE)] <- 1
blankras[blankras < max(values(blankras),na.rm=TRUE)] <- 1

CDEM_montane <- resample(CDEM_montane,blankras)
CDEM_montane <- mask(CDEM_montane,blankras)

Montane_MAT  <- resample(Montane_MAT,blankras)
Montane_MAT <- mask(Montane_MAT,blankras)

Montane_MCMT <- resample(Montane_MCMT,blankras)
Montane_MCMT <- mask(Montane_MCMT,blankras)

SA_montane <- resample(SA_montane,blankras)
SA_montane <- mask(SA_montane,blankras)

NDVI_montane <- resample(NDVI_montane,blankras)
NDVI_montane <- mask(NDVI_montane,blankras)

LandCov_montane <- resample(LandCov_montane,blankras)
LandCov_montane <- mask(LandCov_montane,blankras)

Sprasts_montane <- c(CDEM_montane,
                    Rough_montane,
                    SA_montane,
                    NDVI_montane,
                    LandCov_montane,
                    Montane_MAT,
                    Montane_MCMT
                    )

# Taiga

blankras <- NDVI_taiga
blankras[blankras > min(values(blankras),na.rm=TRUE)] <- 1
blankras[blankras < max(values(blankras),na.rm=TRUE)] <- 1

CDEM_taiga <- resample(CDEM_taiga,blankras)
CDEM_taiga <- mask(CDEM_taiga,blankras)

Taiga_MAT  <- resample(Taiga_MAT,blankras)
Taiga_MAT <- mask(Taiga_MAT,blankras)

Taiga_MCMT <- resample(Taiga_MCMT,blankras)
Taiga_MCMT <- mask(Taiga_MCMT,blankras)

SA_taiga <- resample(SA_taiga,blankras)
SA_taiga <- mask(SA_taiga,blankras)

NDVI_taiga <- resample(NDVI_taiga,blankras)
NDVI_taiga <- mask(NDVI_taiga,blankras)

LandCov_taiga <- resample(LandCov_taiga,blankras)
LandCov_taiga <- mask(LandCov_taiga,blankras)

Sprasts_taiga <- c(CDEM_taiga,
                    Rough_taiga,
                    SA_taiga,
                    NDVI_taiga,
                    LandCov_taiga,
                    Taiga_MAT,
                    Taiga_MCMT
                    )

```


# Pseudo-absent data

I originally started with PseuAbs rstats package, that was developed by:

Descombes, P., Chauvier, Y., Brun, P., Righetti, D., Wüest, R.O., Karger, D.N., Zurell, D. & Zimmermann, N.E. (2022). Strategies for sampling pseudo-absences for species distribution models in complex mountainous terrain. bioRxiv, 2022.03.24.485693.

The source code was reviewed through the GitHub source:

https://github.com/filBe87/PseuAbs/blob/0744d9a753d570524140b0182f9e33e99d1a4585/R/wsl_samplePseuAbs.R

There are three pseu.abs samples that are varied by the "add.strat = x" parameters. The value equals the proportion of pseudo samples that are sampled out of the stratification. So a setting of 0.2 will mean that 20% of the psdeuo-absences are randomly sampled within strata and 80% are randomly sampled without stratification. In contrast, a setting of 0.8 produces a more clumped psdeuo-absence sampling distribution within the strata with 20% sampling into areas outside of what might be expected as suitable habitat. A setting of 0.8 is selected for the model used, but other values can be tested. Note also that I use "presence", which includes only 33 of the original 66 known points. These were trimmed to include only points that exist within a vegetation pixel that was not classified with a "NA" value. The vegetation "NA" pixels can be filled in using other remote sensing data, such as a radar based NDVI. However, some of the values are "NA" by chance and this adds a layer of uncertainty in the input data. Adding uncertainty in the input data can improve on the predictability of the model. The PseuAbs package removes presence data in the sampling process.

The current explanatory rasters include:

Taiga_ExpRas <- c("CDEM_taiga","Rough_taiga","SA_taiga","NDVI_taiga","LandCov_taiga","Taiga_MAT","Taiga_MCMT")


PseuAbs approach - not published yet.
pseu.abs = wsl.samplePseuAbs(type="random",
                            n=5000,
                            env.stack=Sprasts_boreal,
                            template_dir=here::here("Stratification"),
                            pres=AMMA_pres,
                            geores_fact=3,
                            add.strat=0.8,
                            env.strat_path=here::here("Stratification"),
                            force_spat_thin='presences'
                            )

I shifted to dismo package approach:https://rspatial.org/raster/sdm/3_sdm_absence-background.html


```{r Pseudo_Abs, echo=FALSE, eval=FALSE}

# Original data in latlon per dismo style

AMMA <- vect(paste0(here("Inputs","AmphibianLocations"),"/AMMA_Total.shp"))
EcoZone <- terra::project(EcoZone,AMMA)
AMMA <- crop(AMMA,EcoZone)

AMMA_pres <- as.data.frame(geom(AMMA))
AMMA_pres <- AMMA_pres[,c(3:4)]
AMMA_pres$ID = paste0("T",1:nrow(AMMA_pres))
AMMA_pres <- AMMA_pres[,c(3,1:2)]
AMMA_pres$PA <- 1
names(AMMA_pres) <- c("ID","lat","lon","PA")

# Dismo
AMMA_presd <- AMMA_pres
coordinates(AMMA_presd) <- ~lat+lon
projection(AMMA_presd) <- CRS('+proj=longlat +datum=WGS84')

# circles with a radius of 50 km
x <- circles(AMMA_presd, d=50000, lonlat=TRUE)
pol <- polygons(x)

# sample randomly from all circles
AMMA_Pseudo1 <- spsample(pol, nrow(AMMA_presd)/25, type='stratified', iter=25)
AMMA_abs <- as.data.frame(geom(AMMA_Pseudo1))
AMMA_abs$ID = paste0("F",1:nrow(AMMA_abs))
AMMA_abs <- AMMA_abs[,c(4,2:3)]
AMMA_abs$PA <- 0
names(AMMA_abs) <- c("ID","lat","lon","PA")


#AMTI

AMTI <- vect(paste0(here("Inputs","AmphibianLocations"),"/AMTI_Total.shp"))
AMTI <- crop(AMTI,EcoZone)

AMTI_pres <- as.data.frame(geom(AMTI))
AMTI_pres <- AMTI_pres[,c(3:4)]
AMTI_pres$ID = paste0("T",1:nrow(AMTI_pres))
AMTI_pres <- AMTI_pres[,c(3,1:2)]
AMTI_pres$PA <- 1
names(AMTI_pres) <- c("ID","lat","lon","PA")

# Dismo
AMTI_presd <- AMTI_pres
coordinates(AMTI_presd) <- ~lat+lon
projection(AMTI_presd) <- CRS('+proj=longlat +datum=WGS84')

# circles with a radius of 50 km
x <- circles(AMTI_presd, d=50000, lonlat=TRUE)
pol <- polygons(x)

# sample randomly from all circles
AMTI_Pseudo1 <- spsample(pol, nrow(AMTI_presd)/25, type='stratified', iter=25)
AMTI_abs <- as.data.frame(geom(AMTI_Pseudo1))
AMTI_abs$ID = paste0("F",1:nrow(AMTI_abs))
AMTI_abs <- AMTI_abs[,c(4,2:3)]
AMTI_abs$PA <- 0
names(AMTI_abs) <- c("ID","lat","lon","PA")

# ANBO
ANBO <- vect(paste0(here("Inputs","AmphibianLocations"),"/ANBO_Total.shp"))
ANBO <- crop(ANBO,EcoZone)

ANBO_pres <- as.data.frame(geom(ANBO))
ANBO_pres <- ANBO_pres[,c(3:4)]
ANBO_pres$ID = paste0("T",1:nrow(ANBO_pres))
ANBO_pres <- ANBO_pres[,c(3,1:2)]
ANBO_pres$PA <- 1
names(ANBO_pres) <- c("ID","lat","lon","PA")

# Dismo
ANBO_presd <- ANBO_pres
coordinates(ANBO_presd) <- ~lat+lon
projection(ANBO_presd) <- CRS('+proj=longlat +datum=WGS84')

# circles with a radius of 50 km
x <- circles(ANBO_presd, d=50000, lonlat=TRUE)
pol <- polygons(x)

# sample randomly from all circles
ANBO_Pseudo1 <- spsample(pol, nrow(ANBO_presd)/25, type='stratified', iter=25)
ANBO_abs <- as.data.frame(geom(ANBO_Pseudo1))
ANBO_abs$ID = paste0("F",1:nrow(ANBO_abs))
ANBO_abs <- ANBO_abs[,c(4,2:3)]
ANBO_abs$PA <- 0
names(ANBO_abs) <- c("ID","lat","lon","PA")

# RASY
RASY <- vect(paste0(here("Inputs","AmphibianLocations"),"/RASY_Total.shp"))
RASY <- terra::project(RASY,  CRS('+proj=longlat +datum=WGS84'))
RASY <- crop(RASY,EcoZone)

RASY_pres <- as.data.frame(geom(RASY))
RASY_pres <- RASY_pres[,c(3:4)]
RASY_pres$ID = paste0("T",1:nrow(RASY_pres))
RASY_pres <- RASY_pres[,c(3,1:2)]
RASY_pres$PA <- 1
names(RASY_pres) <- c("ID","lat","lon","PA")

# Dismo
RASY_presd <- RASY_pres
coordinates(RASY_presd) <- ~lat+lon
projection(RASY_presd) <- CRS('+proj=longlat +datum=WGS84')

# circles with a radius of 50 km
x <- circles(RASY_presd, d=50000, lonlat=TRUE)
pol <- polygons(x)

# sample randomly from all circles
RASY_Pseudo1 <- spsample(pol, nrow(RASY_presd)/25, type='stratified', iter=25)
RASY_abs <- as.data.frame(geom(RASY_Pseudo1))
RASY_abs$ID = paste0("F",1:nrow(RASY_abs))
RASY_abs <- RASY_abs[,c(4,2:3)]
RASY_abs$PA <- 0
names(RASY_abs) <- c("ID","lat","lon","PA")

# RALU
RALU <- vect(paste0(here("Inputs","AmphibianLocations"),"/RALU_Total.shp"))
RALU <- terra::project(RALU,  CRS('+proj=longlat +datum=WGS84'))
RALU <- crop(RALU,EcoZone)

RALU_pres <- as.data.frame(geom(RALU))
RALU_pres <- RALU_pres[,c(3:4)]
RALU_pres$ID = paste0("T",1:nrow(RALU_pres))
RALU_pres <- RALU_pres[,c(3,1:2)]
RALU_pres$PA <- 1
names(RALU_pres) <- c("ID","lat","lon","PA")

# Dismo
RALU_presd <- RALU_pres
coordinates(RALU_presd) <- ~lat+lon
projection(RALU_presd) <- CRS('+proj=longlat +datum=WGS84')

# circles with a radius of 50 km
x <- circles(RALU_presd, d=50000, lonlat=TRUE)
pol <- polygons(x)

# sample randomly from all circles
RALU_Pseudo1 <- spsample(pol, nrow(RALU_presd)/25, type='stratified', iter=25)
RALU_abs <- as.data.frame(geom(RALU_Pseudo1))
RALU_abs$ID = paste0("F",1:nrow(RALU_abs))
RALU_abs <- RALU_abs[,c(4,2:3)]
RALU_abs$PA <- 0
names(RALU_abs) <- c("ID","lat","lon","PA")

# Buffer the points by 1 km
AMMA_Pseudo1 <- terra::crop(vect(AMMA_Pseudo1), ext(EcoZone))
AMMA_Pseudo1$ID <- paste0("F",1:nrow(AMMA_Pseudo1)) 

AMTI_Pseudo1 <- crop(vect(AMTI_Pseudo1), ext(EcoZone))
AMTI_Pseudo1$ID <- paste0("F",1:nrow(AMTI_Pseudo1)) 

ANBO_Pseudo1 <- crop(vect(ANBO_Pseudo1), ext(EcoZone))
ANBO_Pseudo1$ID <- paste0("F",1:nrow(ANBO_Pseudo1)) 

RALU_Pseudo1 <- crop(vect(RALU_Pseudo1), ext(EcoZone))
RALU_Pseudo1$ID <- paste0("F",1:nrow(RALU_Pseudo1)) 

RASY_Pseudo1 <- crop(vect(RASY_Pseudo1), ext(EcoZone))
RASY_Pseudo1$ID <- paste0("F",1:nrow(RASY_Pseudo1)) 

AMMA_Pseudo1_1km <- buffer(AMMA_Pseudo1,
                   1000)
AMTI_Pseudo1_1km <- buffer(AMTI_Pseudo1,
                   1000)
ANBO_Pseudo1_1km <- buffer(ANBO_Pseudo1,
                   1000)
RALU_Pseudo1_1km <- buffer(RALU_Pseudo1,
                   1000)
RASY_Pseudo1_1km <- buffer(RASY_Pseudo1,
                   1000)

```

# Random Forest models

I have sampled the median value for all explanatory rasters 1 km around known points and the pseudo absence points.

AMMA <- Ambystoma macrodactylum
AMTI <- Ambystoma tigrinum
ANBO <- Anaxyrus boreas
RASY <- Rana sylvatica
RALU <- Rana luteiventris

AMMA_1km <- buffer(AMMA,
                   1000)
AMTI_1km <- buffer(AMTI,
                   1000)
ANBO_1km <- buffer(ANBO,
                   1000)
RALU_1km <- buffer(RALU,
                   1000)
RASY_1km <- buffer(RASY,
                   1000)


```{r RF_Stat, echo=TRUE, eval=FALSE}

# Start AMMA - True Record
AMMA_1km$ID <- paste0("T",AMMA_pres$ID)
AMMA_1km_montane <- crop(AMMA_1km, Montane)

# Extract the median values - True Records
Montane_AMMA_T <- terra::extract(Sprasts_montane,
             fun="median",
             method="bilinear",
             AMMA_1km_montane,
             na.rm=TRUE)

AMMA_1km_montane$ID <- paste0("T",Montane_AMMA_T$ID)
Montane_AMMA_T$ID <- AMMA_1km_montane$ID
AMMA_1km_montane <- AMMA_1km_montane[,85]
Montane_AMMA_T$PA <- 1

# Pseudo AMMA
AMMA_Pseudo1_1km <- terra::project(AMMA_Pseudo1_1km, Montane)
AMMA_F_1km_montane <- crop(AMMA_Pseudo1_1km, Montane)

AMMA_F_1km_montane$ID <- AMMA_Pseudo1$ID
AMMA_F_1km_montane <- crop(AMMA_Pseudo1_1km, Montane)


# Extract the median values - Pseudo Records
Montane_AMMA_F <- terra::extract(Sprasts_montane,
             fun="median",
             method="bilinear",
             AMMA_F_1km_montane,
             na.rm=FALSE)

Montane_AMMA_F$ID <- AMMA_F_1km_montane$ID
Montane_AMMA_F$PA <- 0

Montane_AMMA_T2 <- merge(Montane_AMMA_T,AMMA_pres,by=c("ID","PA"))
Montane_AMMA_F2 <- merge(Montane_AMMA_F,AMMA_abs,by=c("ID","PA"))

AMMA_data <- rbind(Montane_AMMA_T2,Montane_AMMA_F2)

names(Sprasts_montane) <- c("elev","Rough","SA","NDVI","LC","MAT","MCMT")
AMMA_data$PA <- as.factor(AMMA_data$PA)


## AMMA ----
AMMA_rfm <- randomForest(formula=PA ~ elev + Rough + SA + NDVI + LC + MAT + MCMT, data=AMMA_data)


varImpPlot(AMMA_rfm,
           main = "Bagging: Variable importance")


## approach 1, use the "cpkgs" argument 
modlist <- list()
modlist[[1]] <- assign(paste0("AMMA","_rfp1"),predict(Sprasts_montane,
               AMMA_rfm,
               cores=n.cores,
               cpkgs="randomForest")
)


AMMA_SDM <- modelling('RF', AMMA_data, 
                 Sprasts_montane, Xcol = 'lon', Ycol = 'lat')


nmx <- paste0("AMMA","_rfp1")

writeRaster(modlist[[1]],paste0(here("Outputs","Rasters"),"/RF_As_rp1a.tif"), overwrite=TRUE)

tm_shape(modlist[[1]]) +
  tm_raster(style= "kmeans", legend.show=FALSE) +
  tm_shape(Eco_metplot_vs[which(Eco_metplot_vs$metal == "Copper"),]) + 
  tm_symbols(shape = 21, size = "value",
             title.size = "Concentration (ppm)", col = "goldenrod4", border.col="black") +
tm_scale_bar(position = c("left", "bottom"))+
tm_layout(main.title = "Copper",
            bg.color = "lightgrey", inner.margins = c(-0.5, -0.3, -0.2, -0.4)) +  tm_compass(position = c("right", "top"), size = 2)

```


