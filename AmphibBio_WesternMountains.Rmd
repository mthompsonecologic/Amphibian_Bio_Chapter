---
title: "Amphibian_Biology"
author: "MThompson"
date: "2024-03-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries


```{r Libraries}

list.of.packages <- c(
  "stringr",
  "here",
  "terra",
  "future",
  "class",
  "reshape",
  "ggplot2",
  "sf",
  "XML",
  "exiftoolr",
  "curl",
  "RCurl",
  "httr",
  "ncdf4",
  "future",
  "rsi",
  "rstac",
  "doParallel",
  "usethis",
  "RColorBrewer",
  "dismo",
  "randomForest",
  "SSDM",
  "ranger",
  "tmap",
  "BiodiversityR",
  "tidyverse",
  "viridis",
  "tmaptools",
  "devtools"
)

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]

if(length(new.packages) > 0){
  install.packages(new.packages, dep=TRUE)
}

#loading packages
for(package.i in list.of.packages){
  suppressPackageStartupMessages(
    library(
      package.i, 
      character.only = TRUE
    )
  )
}

#Developer version needed
#install.packages("terra", repos = "https://rspatial.r-universe.dev")
#library(terra)

# Local
install.packages(paste0(here("Inputs","ClimateNA"),"/ClimateNAr_1.2.0.zip"),
                 repos = NULL,
                 type = "win.binary")
library(ClimateNAr)
n.cores <- future::availableCores() - 1

```

## Spatial data


## EcoZones and BEC polygons processing


```{r spatial_dat, echo=FALSE}

# Pull in Biogeoclimatic spatial info from BC and Yukon
BEC1 <- vect(paste0(here("Inputs","Shapefiles"),
                    "/BEC_POLY_polygon.shp"))
BEC2 <- vect(paste0(here("Inputs","Shapefiles"),
                    "/BEC_POLY_polygon.shp"))
BEC3 <- vect(paste0(here("Inputs","Shapefiles"),
                    "/YukonBEC_Vect.shp"))

EcoZone <- vect(paste0(here("Inputs","Shapefiles"),
                       "/Chapter_EcoZone.shp"))

EcoZone <- terra::project(EcoZone,
                          "EPSG:32610")


BEC3 <- terra::project(BEC3,
                EcoZone)
BEC3 <- mask(BEC3,
             EcoZone)
BEC3 <- crop(BEC3,
             EcoZone)

writeVector(BEC3,
            paste0(here("Inputs","Shapefiles"),
                   "/YukonBEC_Vect_EcoZone2.shp"),
            overwrite=TRUE)

BEC2 <- terra::project(BEC2,
                EcoZone)
BEC2 <- mask(BEC2,
             EcoZone)
BEC2 <- crop(BEC2,
             EcoZone)

writeVector(BEC2,
            paste0(here("Inputs","Shapefiles"),
                   "/BC_BEC_Vect_EcoZone.shp"),
            overwrite=TRUE)

# To QGIS to fin the mapping
#BECx <- merge(BEC2,BEC3) 

# Clip Canada freshwater
# Source: https://open.canada.ca/data/en/dataset/d0cdef71-9343-46c3-b2e7-c1ded5907686

Freshwater <- vect(paste0(here(here("Inputs","Shapefiles")),
                          "/lhy_000c16a_e.shp"))
Freshwater <- terra::project(Freshwater,
                      "EPSG:32610")
Freshwater <- crop(Freshwater,
                   EcoZone)

writeVector(Freshwater,
            paste0(here("Inputs","Shapefiles"),
                   "/Freshwater_Gov.shp"),
            overwrite=TRUE)

#########################################
# Convert amphibian records to shapefiles
# read coordinates with getKMLcoordinates()

Amac <- st_read(paste0(here("Inputs","Shapefiles","AmphibiaWeb_data"),
                          "/Amacro.kml"))
Amac <- vect(Amac)
writeVector(Amac,
            paste0(here("Inputs","Shapefiles","AmphibiaWeb_data"),
                       "/Amacro.shp"),
            overwrite=TRUE)

# Calling in data from gpx

gpx_parsed <- htmlTreeParse(file = paste0(here("Inputs","AmphibianLocations"),
                                          "/Lawyers_Wildlife_MDT.gpx"),
                            useInternalNodes = TRUE)

coords <- xpathSApply(doc = gpx_parsed, path = "//wpt", fun = xmlAttrs)
elevation <- xpathSApply(doc = gpx_parsed, path = "//wpt/ele", fun = xmlValue)

df <- data.frame(
  lat = as.numeric(coords["lat", ]),
  lon = as.numeric(coords["lon", ]),
  elevation = as.numeric(elevation)
)

```

# Canada DEM

The Canada DEM is retrieved using the ftp repository. This required a visual check on the grid sheets using GoogleEarth and the spatRaster plots to fill in the gaps. The CRS projections in the northern extents also required lat/long rather than UTM to merge all the pieces together, so the data is projected and merged accordingly. This was done in pieces like a jigsaw puzzle and the code reflects this history. The basic formulation is to list the sheets to download, unpack the zip files, project the data, and bring it together using virtual rasters to save on memory and processing time.

```{r DEM, echo=FALSE, eval=FALSE}


###############################################
# Canada DEM download for distribution models
Sheets <- c("082",
            "083",
            "084",
            "092",
            "093",
            "094",
            "095",
            "096",
            "104",
            "105",
            "106",
            "114",
            "115",
            "116",
            "117")


for(i in 1:length(Sheets)){
  URL = paste0("ftp.maps.canada.ca/pub/nrcan_rncan/elevation/cdem_mnec/"
               ,Sheets[i],
               "/")
  filenames <- getURL(URL,
                      dirlistonly = TRUE)
  files <- unlist(strsplit(filenames,
                           '\r\n'))
  files_full <- paste0(here("DEM","CDEM"),
                       "/",
                       files)
  
  for(r in 1:length(files_full)){
    download.file(paste0(URL,files[r]),
                  destfile = files_full[r],
                  method="libcurl")
  }
  }

# Extract the Zipfiles:
zipfiles <- dir(here("DEM","CDEM"),
                pattern="\\D_tif.zip$",
                full.names=TRUE)

for(i in 1:length(zipfiles)){
    unzip(zipfiles[i],
          exdir = here("DEM","CDEM"),
          overwrite = FALSE)
}

# Hijmans described:
# https://stackoverflow.com/
# 70946870

DEM_dir <- dir(here("Inputs","Rasters","CDEM"),
                 full.names=TRUE,
                 pattern="cdem_dem_\\d{2,}\\D.tif$")

DEM_rasts <- vrt(DEM_dir)

# Run each ecozone (1-3) separately
EcoZonet <- project(EcoZone,
                    DEM_rasts)
DEM_rasts1 <- crop(DEM_rasts,
                   EcoZonet[1,])
DEM_rasts2 <- crop(DEM_rasts,
                   EcoZonet[2,])
DEM_rasts3 <- crop(DEM_rasts,
                   EcoZonet[3,])

newcrs="epsg:3005"
n.cores <- future::availableCores() - 1

DEM_rasts1 <- project(DEM_rasts1,
                      newcrs,
                      method="cubicspline",
                      filename=paste0(here("Inputs","Rasters","CDEM"),
                                      "/DEM_rasts1.tif"),
                      threads=n.cores,
                      overwrite=TRUE,
                      res=20
)

DEM_rasts2 <- project(DEM_rasts2,
                      newcrs,
                      method="cubicspline",
                      filename=paste0(here("Inputs","Rasters","CDEM"),
                                      "/DEM_rasts2.tif"),
                      threads=n.cores,
                      overwrite=TRUE,
                      res=20
)

DEM_rasts3 <- project(DEM_rasts3,
                      newcrs,
                      method="cubicspline",
                      filename=paste0(here("Inputs","Rasters","CDEM"),
                                      "/DEM_rasts3.tif"),
                      threads=n.cores,
                      overwrite=TRUE,
                      res=20
)

# Apply approach
#f <- lapply(DEM_rasts,
#            terra::rast)
#f <- sprc(f)
#f.mosaic <- mosaic(f, fun="mean")

# I ran m and f.mosaic above using
# the slow and fast methods respectively.
# This created a southern (f.mosaic) and
# northern part. I kept them apart to
# keep the projection processing manageable.

# Simplify to remove inner lines for mask
Ecodis <- aggregate(EcoZone)

DEM_rastsm1 <- mask(DEM_rasts1,
                    Ecodis,
                    threads=n.cores)

writeRaster(DEM_rastsm1,
            paste0(here("Inputs","Rasters","CDEM"),
                   "/DEM_rastsm1.tif"),
            overwrite=TRUE)

DEM_rastsm2 <- mask(DEM_rasts2,
                    Ecodis,
                    threads=n.cores)

writeRaster(DEM_rastsm2,
            paste0(here("Inputs","Rasters","CDEM"),
                   "/DEM_rastsm2.tif"),
            overwrite=TRUE)

DEM_rastsm3 <- mask(DEM_rasts3,
                    Ecodis,
                    threads=n.cores)

writeRaster(DEM_rastsm3,
            paste0(here("Inputs","Rasters","CDEM"),
                   "/DEM_rastsm3.tif"),
            overwrite=TRUE)

DEM_rastsm1 <- rast(paste0(here("Inputs","Rasters","CDEM"),
                           "/DEM_rastsm1.tif"))

DEM_rastsm2 <- rast(paste0(here("Inputs","Rasters","CDEM"),
                           "/DEM_rastsm2.tif"))

DEM_rastsm3 <- rast(paste0(here("Inputs","Rasters","CDEM"),
                           "/DEM_rastsm3.tif"))

DEM_rastsm123 <- dir(here("Inputs","Rasters","CDEM"),
                     pattern="DEM_rastsm\\d.tif$",
                     full.names=TRUE)

v <- vrt(DEM_rastsm123)
CDEM_full <- writeRaster(v,
                         paste0(here("Inputs","Rasters","CDEM"),
                                "/CDEM_total.tif"),
                         overwrite=TRUE)

CDEM_full <- rast(paste0(here("Inputs","Rasters","CDEM"),
                         "/CDEM_total.tif"))

EcoZone <- project(EcoZone,
                   CDEM_full)

## The challenge: Using UTM conversions
## from far northern extents do not
## always proceed well in reprojection.
## I had to iterate through projections
## to bring all into one projection.

# Patchwork fix:
#105I-J, 117, 106G, and 095L missed

d095L <- rast(DEM_dir[108])
d095L <- project(d095L,
                 "EPSG:3005",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d095L.tif")
                 )

d105I <- rast(DEM_dir[151])
d105I <- project(d105I,
                 "EPSG:3005",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d105I.tif")
)

d106G <- rast(DEM_dir[165])
d106G <- project(d106G,
                 "EPSG:3005",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d106G.tif")
                 )

d117A <- rast(DEM_dir[202])
d117A <- project(d117A,
                 "EPSG:32610",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d117A.tif")
                 )

d117A2 <- project(d117A,
                  "EPSG:3005",
                  threads=n.cores,
                  res=20,
                  filename=paste0(here("Inputs","Rasters","CDEM"),
                                  "/d117A2.tif")
)


d117B <- rast(DEM_dir[203])
d117B <- project(d117B,
                 "EPSG:32610",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d117B.tif")
                 )
d117B2 <- project(d117B,
                  "EPSG:3005",
                  threads=n.cores,
                  res=20,
                  filename=paste0(here("Inputs","Rasters","CDEM"),
                                  "/d117B2.tif")
)

d117C <- rast(DEM_dir[204])
d117C <- project(d117C,
                 "EPSG:32610",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d117C.tif")
                 )
d117C2 <- project(d117C,
                  "EPSG:3005",
                  threads=n.cores,
                  res=20,
                  filename=paste0(here("Inputs","Rasters","CDEM"),
                                  "/d117C2.tif")
)

d117D <- rast(DEM_dir[205])
d117D <- project(d117D,
                 "EPSG:32610",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d117D.tif")
                 )
d117D2 <- project(d117D,
                 "EPSG:3005",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d117D2.tif")
)

d103P <- rast(paste0(here("Inputs","Rasters","CDEM",
                          "cdem_dem_103P_tif"),
                     "/cdem_dem_103P.tif"))

d103P <- project(d103P,
                 "EPSG:32610",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d103P.tif")
                 )

d103P <- project(d103P,
                 "EPSG:3005",
                 threads=n.cores,
                 res=20,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d103P_3005.tif")
)

d103P <- rast(paste0(here("Inputs","Rasters","CDEM"),
                     "/d103P_3005.tif"))

dDEMs <- c(paste0(here("Inputs","Rasters","CDEM"),
                  "/d095L.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d105I.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d106G.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d117A2.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d117B2.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d117C2.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d117D2.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d103P_3005.tif")
           )

v <- vrt(dDEMs)
v <- mask(v,
          Ecodis,
          threads=n.cores)

newDEM_rasts <- writeRaster(v,
                         paste0(here("Inputs","Rasters","CDEM"),
                                "/newDEM_rasts.tif"),
                         overwrite=TRUE)

newDEM_rasts <- rast(paste0(here("Inputs","Rasters","CDEM"),
                            "/newDEM_rasts.tif"))

DEM_tot_new <- c(dir(here("Inputs","Rasters","CDEM"),
                     pattern="CDEM_total.tif$",
                     full.names=TRUE),
                 dir(here("Inputs","Rasters","CDEM"),
                     pattern="newDEM_rasts.tif$",
                     full.names=TRUE)
                 )

v <- vrt(DEM_tot_new)

CDEM_Total <- writeRaster(v,
                         paste0(here("Inputs","Rasters","CDEM"),
                                "/CDEM_Total2.tif"),
                         overwrite=TRUE)

CDEM_Total <- rast(paste0(here("Inputs","Rasters","CDEM"),
                         "/CDEM_Total2.tif"))

EcoZonet <- project(EcoZone,
                    CDEM_Total)

#Taiga = 3, montane=2, boreal=1
CDEM_taiga <- mask(CDEM_Total,
                   EcoZonet[3,],
                   threads=n.cores)
CDEM_boreal <- mask(CDEM_Total,
                    EcoZonet[1,],
                    threads=n.cores)
CDEM_montane <- mask(CDEM_Total,
                     EcoZonet[2,],
                     threads=n.cores)

writeRaster(CDEM_taiga,
            paste0(here("Inputs","Rasters","CDEM"),
                   "/CDEM_taiga.tif"),
                   overwrite=TRUE)

writeRaster(CDEM_boreal,
            paste0(here("Inputs","Rasters","CDEM"),
                   "/CDEM_boreal.tif"),
                   overwrite=TRUE)

writeRaster(CDEM_montane,
            paste0(here("Inputs","Rasters","CDEM"),
                   "/CDEM_montane.tif"),
                   overwrite=TRUE)

CDEM_taiga <- rast(paste0(here("Inputs","Rasters","CDEM"),
                          "/CDEM_taiga.tif"))
CDEM_boreal <- rast(paste0(here("Inputs","Rasters","CDEM"),
                          "/CDEM_boreal.tif"))
CDEM_montane <- rast(paste0(here("Inputs","Rasters","CDEM"),
                          "/CDEM_montane.tif"))

## Last few -

URL = paste0("ftp.maps.canada.ca/pub/nrcan_rncan/elevation/cdem_mnec/"
              ,107,
              "/")

filenames <- getURL(URL,
                     dirlistonly = TRUE)

files <- unlist(strsplit(filenames,
                          '\r\n'))
files_full <- paste0(here("DEM","CDEM"),
                      "/",
                      files)
 
for(r in 1:length(files_full)){
    download.file(paste0(URL,files[r]),
                  destfile = files_full[r],
                  method="libcurl")
}

d107B <- rast(paste0(here("DEM","CDEM"),"/cdem_dem_107B.tif"))
d107B <- project(d107B, crs(EcoZone),
                 threads=n.cores,
                 res=250,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d107B.tif"), overwrite=TRUE
                 )

d106M <- rast(DEM_dir[172])
d106M <- project(d106M,
                 crs(EcoZone),
                 threads=n.cores,
                 res=250,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d106M.tif"), overwrite=TRUE
                 )



```


# rsi Data

This code chunk uses the rsi package (https://cran.r-project.org/web/packages/rsi/index.html) to: "Efficiently Retrieve and Process Satellite Imagery".

Search for NDVI data (MODIS Vegetation Indices 16-Day (250m) https://planetarycomputer.microsoft.com/dataset/modis-13Q1-061) for 2023 over the EcoZone.

```{r rsi, echo=FALSE, eval=FALSE}

# Aggregate for single
EcoZonea <- aggregate(EcoZone)
writeVector(EcoZonea,
            paste0(here("Inputs","Shapefiles"),
                   "/EcoZoneagg.shp"),
            overwrite=TRUE)

EcoZonea <- project(EcoZonea, "epsg:4326")
EcoZonea_ext <- as.numeric(as.matrix(ext(EcoZonea)))

EcoZone1 <- EcoZone[1]
writeVector(EcoZone1,
            paste0(here("Inputs","Shapefiles"),
                   "/EcoZone1.shp"),
            overwrite=TRUE)

stac_source <- rstac::stac(
  "https://planetarycomputer.microsoft.com/api/stac/v1"
)

rstac::stac_search(
  q = stac_source,
  collections = "modis-13Q1-061",
  bbox = c(EcoZonea_ext[1],
           EcoZonea_ext[2],
           EcoZonea_ext[3],
           EcoZonea_ext[4]),
  datetime = "2023-05-15/2023-08-31",
  limit = 999
) |> 
  rstac::get_request()

EcoZonea_sf <- sf::st_as_sf(EcoZonea)

Modis_VI <- get_stac_data(
  EcoZonea_sf,
  start_date = "2023-05-15",
  end_date = "2023-08-31",
  stac_source="https://planetarycomputer.microsoft.com/api/stac/v1",
  collection = "modis-13Q1-061",
  asset_names = "250m_16_days_EVI",
  composite_function=NULL,
  output_filename = paste0(here::here("Outputs","Rasters"),"/MODIS23.tif")
)

Modis_VI <- dir(paste0(here::here("Outputs","Rasters")), full.names=TRUE)
       
# TEST
#xm <- project(rast(Modis_VI[1]), "EPSG:32610", threads=n.cores, res=250)

f <- lapply(Modis_VI,
            terra::rast)

f2 <- lapply(f, function(x) project(x, y = 'epsg:32610', threads=n.cores, res=250))

f3 = Filter(function(r){!all(is.nan(values(r)))}, f2)


my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)
f.mosaic <- do.call(mosaic, f3)
# Stop the parallel backend
stopCluster(my.cluster)

writeRaster(f.mosaic,filename=paste0(here::here("Outputs","Rasters"),
                                     "/MODIS_FULL.tif"), overwrite=TRUE)

MODIS_FULL <- mask(f.mosaic,EcoZone,threads=n.cores)

writeRaster(MODIS_FULL,filename=paste0(here::here("Outputs","Rasters"),
                                     "/MODIS_FULL.tif"), overwrite=TRUE)

##############
# Piece is still missing in northern clip.
# Try again, smaller

EcoZone3 <- EcoZone[3]

EcoZone3 <- sf::st_as_sf(EcoZone3)

Modis_VI <- get_stac_data(
  EcoZone3,
  start_date = "2023-05-15",
  end_date = "2023-08-31",
  stac_source="https://planetarycomputer.microsoft.com/api/stac/v1",
  collection = "modis-13Q1-061",
  asset_names = "250m_16_days_EVI",
  composite_function=NULL,
  output_filename = paste0(here::here("Outputs","Rasters"),"/MODIS_N.tif")
)

Modis_VI_N <- dir(paste0(here::here("Outputs","Rasters")),
                  full.names=TRUE,
                  pattern="MODIS_N_\\d{1,}.tif$")


f <- lapply(Modis_VI_N,
            terra::rast)

f2 <- lapply(f, function(x) project(x, y = 'epsg:32610', threads=n.cores, res=250))
f3 = Filter(function(r){!all(is.nan(values(r)))}, f2)

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)
f.mosaic <- do.call(mosaic, f3)
# Stop the parallel backend
stopCluster(my.cluster)

MODIS_FULL2 <- merge(MODIS_FULL,f.mosaic)

MODIS_FULL <- mask(MODIS_FULL2,EcoZone,threads=n.cores)

writeRaster(MODIS_FULL,filename=paste0(here::here("Outputs","Rasters"),
                                     "/MODIS_FULL.tif"), overwrite=TRUE)


```


# Integrate the rasters


```{r Explan_Rasts, echo=FALSE}

MODIS_FULL <- rast(paste0(here::here("Outputs","Rasters"),
                                     "/MODIS_FULL.tif"))

# Put all these rasters into the inputs
writeRaster(MODIS_FULL,
            filename=paste0(here::here("Inputs",
                                       "Rasters",
                                       "Explanatory"),
                                     "/MODIS_FULL.tif"),
            overwrite=TRUE)


CDEM_Total <- rast(paste0(here("Inputs","Rasters","CDEM"),
                         "/CDEM_Total2.tif"))

LandCov <- rast(paste0(here("Inputs","Rasters","Explanatory"),
                                     "/amph_ecozone_landcover.tif"))

CDEM_Total <- project(CDEM_Total,MODIS_FULL,
                      threads=n.cores,
                      res=250)

writeRaster(CDEM_Total,
            filename=paste0(here::here("Inputs",
                                       "Rasters",
                                       "Explanatory"),
                                     "/CDEM_Total.tif"),
            overwrite=TRUE)

LandCov <-  project(LandCov,
                    MODIS_FULL,
                    threads=n.cores,
                    res=250)
writeRaster(LandCov,
            filename=paste0(here::here("Inputs",
                                       "Rasters",
                                       "Explanatory"),
                                     "/LandCov.tif"),
            overwrite=TRUE)


MODIS_FULL <- rast(paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/MODIS_FULL.tif"))

LandCov <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/LandCov.tif"))

CDEM_Total <- rast(paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_Total.tif"))

# Add the last missing pieces
d106M <- project(d106M,
                 crs(CDEM_Total),
                 threads=n.cores,
                 res=250,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d106M.tif"), overwrite=TRUE)

d107B <- project(d107B,
                 crs(CDEM_Total),
                 threads=n.cores,
                 res=250,
                 filename=paste0(here("Inputs","Rasters","CDEM"),
                                 "/d107B.tif"), overwrite=TRUE)

dDEMs <- c(paste0(here("Inputs","Rasters","CDEM"),
                  "/d106M.tif"),
           paste0(here("Inputs","Rasters","CDEM"),
                  "/d107B.tif")
           )

v <- vrt(dDEMs)
v <- mask(v,
          EcoZone[3],
          threads=n.cores)

newDEM_rasts <- writeRaster(v,
                         paste0(here("Inputs","Rasters","CDEM"),
                                "/newDEM_rasts.tif"),
                         overwrite=TRUE)

newDEM_rasts <- rast(paste0(here("Inputs","Rasters","CDEM"),
                            "/newDEM_rasts.tif"))

DEM_tot_new <- c(dir(here("Inputs","Rasters","CDEM"),
                     pattern="newDEM_rasts.tif",
                     full.names=TRUE),
                 paste0(here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_Total.tif")
                 )
                 

v <- vrt(DEM_tot_new)

CDEM_Total <- writeRaster(v,
                         paste0(here("Inputs","Rasters","CDEM"),
                                "/CDEM_Total.tif"),
                         overwrite=TRUE)



```


#Climate NA

See: https://climatena.ca/


```{r ClimateNA, echo=FALSE}

CDEM_Total <- rast(paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_Total.tif"))

climbc <- rast(paste0(here("InputFiles"),"/BC80k.asc"))
climbcdf <- as.data.frame(climbc) 

EcoZone <- terra::project(EcoZone,
                   crs(climbc))

CDEM_Total <- terra::project(CDEM_Total,
                       crs(climbc),
                      threads=n.cores)

Boreal <- EcoZone[1] # Boreal
Montane <- EcoZone[2] # Montane
Taiga <- EcoZone[3] # Taiga

#Boreal

CDEM_Total1 <- mask(CDEM_Total, Boreal)
CDEM_Total1 <- crop(CDEM_Total1, Boreal, mask=TRUE)
values(CDEM_Total1) <- as.integer(values(CDEM_Total1))
CDEM_Total1 <- subst(CDEM_Total1, NA, -9999)

writeRaster(CDEM_Total1,
            paste0(here("Outputs","Rasters","Explanatory"),
                         "/CDEM_boreal.asc"),
            NAflag=-9999, overwrite=TRUE)

temp <- readLines(paste0(here("Outputs","Rasters","Explanatory"),
                         "/CDEM_boreal.asc"))

write.table(temp,paste0(here("Outputs","Rasters","Explanatory"),
                         "/CDEM_boreal.asc"),
            row.names=F,
            col.names=F,
            quote=F)

# Montane

CDEM_Total2 <- mask(CDEM_Total, Montane)
CDEM_Total2 <- crop(CDEM_Total2, Montane, mask=TRUE)
values(CDEM_Total2) <- as.integer(values(CDEM_Total2))
CDEM_Total2 <- subst(CDEM_Total2, NA, -9999)

writeRaster(CDEM_Total2,
            paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_montane.asc"),
            NAflag=-9999, overwrite=TRUE)


temp <- readLines(paste0(here("Outputs","Rasters","Explanatory"),
                         "/CDEM_montane.asc"))

write.table(temp,paste0(here("Outputs","Rasters","Explanatory"),
                         "/CDEM_montane.asc"),
            row.names=F,
            col.names=F,
            quote=F)

#Taiga
CDEM_Total3 <- mask(CDEM_Total, Taiga)
CDEM_Total3 <- crop(CDEM_Total3, Taiga, mask=TRUE)
values(Taiga) <- as.integer(values(Taiga))
CDEM_Total3 <- subst(CDEM_Total3, NA, -9999)

writeRaster(CDEM_Total3,
            paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_taiga.asc"),
            NAflag=-9999, overwrite=TRUE)

temp <- readLines(paste0(here("Outputs","Rasters","Explanatory"),
                         "/CDEM_taiga.asc"))

write.table(temp,paste0(here("Outputs","Rasters","Explanatory"),
                         "/CDEM_taiga.asc"),
            row.names=F,
            col.names=F,
            quote=F)


CDEM_boreal <- rast(paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_boreal.asc"))
CDEM_montane <- rast(paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_montane.asc"))
CDEM_taiga <- rast(paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_taiga.asc"))

```

# Amphibian Data: Predictor Variables

```{r Amphib_locs, echo=TRUE, eval=FALSE}

AMMA <- vect(paste0(here("Inputs","AmphibianLocations"),"/AMMA_Total.shp"))
AMMA$ID <- 1:nrow(AMMA)

# BiodiversityR approach to spatially thin the records
AMMAg <- data.frame(crds(AMMA))
AMMAgdf <- SpatialPointsDataFrame(coords = AMMAg[,c(1,2)], data = AMMAg,
                               proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)

system.time({
AMMAgt <- ensemble.spatialThin.quant(AMMAg,
                               thin.km = 1,
                               runs = 100,
                               silent = TRUE,
                               verbose = TRUE)

})
stopCluster(my.cluster)

AMMAmat <- as.matrix(crds(AMMA))
crspoints <- "+proj=longlat +datum=WGS84"
AMMA_pts <- vect(AMMAmat, crs = crspoints)
AMMA_pts$ID <- AMMA$ID
AMMA_pts_s <- sf::st_as_sf(AMMA_pts)

AMMAgt_mat <- as.matrix(AMMAgt)
AMMAgt_pt <- vect(AMMAgt_mat, crs = crspoints)
AMMAgt_pt_s <- sf::st_as_sf(AMMAgt_pt)


df_near <- st_join(AMMAgt_pt_s, AMMA_pts_s, join = st_nearest_feature)
AMMA_join <- vect(df_near)
AMMA <- terra::project(AMMA_join,"EPSG:32610")
AMMA <- crop(AMMA, terra::project(EcoZone,"EPSG:32610"))

# Tigrinum does not need to be thinned
AMTI <- vect(paste0(here("Inputs","AmphibianLocations"),"/AMTI_Total.shp"))
AMTI <- terra::project(AMTI,"EPSG:32610")
AMTI <- crop(AMTI, terra::project(EcoZone,"EPSG:32610"))

#ANBO
ANBO <- vect(paste0(here("Inputs","AmphibianLocations"),"/ANBO_Total.shp"))

# BiodiversityR approach to spatially thin the records
ANBOg <- data.frame(crds(ANBO))
ANBOgdf <- SpatialPointsDataFrame(coords = ANBOg[,c(1,2)], data = ANBOg,
                               proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)

system.time({
ANBOgt <- ensemble.spatialThin.quant(ANBOg,
                               thin.km = 1,
                               runs = 100,
                               silent = TRUE,
                               verbose = TRUE)

})
stopCluster(my.cluster)

ANBOmat <- as.matrix(crds(ANBO))
crspoints <- "+proj=longlat +datum=WGS84"
ANBO_pts <- vect(ANBOmat, crs = crspoints)
ANBO_pts$ID <- ANBO$ID
ANBO_pts_s <- sf::st_as_sf(ANBO_pts)

ANBOgt_mat <- as.matrix(ANBOgt)
ANBOgt_pt <- vect(ANBOgt_mat, crs = crspoints)
ANBOgt_pt_s <- sf::st_as_sf(ANBOgt_pt)


df_near <- st_join(ANBOgt_pt_s, ANBO_pts_s, join = st_nearest_feature)
ANBO_join <- vect(df_near)
#ANBO <- terra::project(ANBO,"EPSG:32610")
ANBO <- crop(ANBO, EcoZone)


#RALU
RALU <- vect(paste0(here("Inputs","AmphibianLocations"),"/RALU_Total.shp"))
RALU <- terra::project(RALU,"EPSG:4326")

# BiodiversityR approach to spatially thin the records
RALUg <- data.frame(crds(RALU))
RALUgdf <- SpatialPointsDataFrame(coords = RALUg[,c(1,2)], data = RALUg,
                               proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)

system.time({
RALUgt <- ensemble.spatialThin.quant(RALUg,
                               thin.km = 1,
                               runs = 100,
                               silent = TRUE,
                               verbose = TRUE)

})
stopCluster(my.cluster)

RALUmat <- as.matrix(crds(RALU))
crspoints <- "+proj=longlat +datum=WGS84"
RALU_pts <- vect(RALUmat, crs = crspoints)
RALU_pts$ID <- RALU$ID
RALU_pts_s <- sf::st_as_sf(RALU_pts)

RALUgt_mat <- as.matrix(RALUgt)
RALUgt_pt <- vect(RALUgt_mat, crs = crspoints)
RALUgt_pt_s <- sf::st_as_sf(RALUgt_pt)

df_near <- st_join(RALUgt_pt_s, RALU_pts_s, join = st_nearest_feature)
RALU_join <- vect(df_near)
RALU <- terra::project(RALU,CRS('+proj=longlat +datum=WGS84'))
RALU <- crop(RALU, EcoZone)

#RASY
RASY <- vect(paste0(here("Inputs","AmphibianLocations"),"/RASY_Total.shp"))
RASY <- terra::project(RASY,"EPSG:4326")
#RASY <- terra::project(RASY,"EPSG:32610")

# BiodiversityR approach to spatially thin the records
RASYg <- data.frame(crds(RASY))
RASYgdf <- SpatialPointsDataFrame(coords = RASYg[,c(1,2)], data = RASYg,
                               proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)

system.time({
RASYgt <- ensemble.spatialThin.quant(RASYg,
                               thin.km = 1,
                               runs = 100,
                               silent = TRUE,
                               verbose = TRUE)

})
stopCluster(my.cluster)

RASYmat <- as.matrix(crds(RASY))
crspoints <- "+proj=longlat +datum=WGS84"
RASY_pts <- vect(RASYmat, crs = crspoints)
RASY_pts$ID <- RASY$ID
RASY_pts_s <- sf::st_as_sf(RASY_pts)

RASYgt_mat <- as.matrix(RASYgt)
RASYgt_pt <- vect(RASYgt_mat, crs = crspoints)
RASYgt_pt_s <- sf::st_as_sf(RASYgt_pt)


df_near <- st_join(RASYgt_pt_s, RASY_pts_s, join = st_nearest_feature)
RASY_join <- vect(df_near)
#RASY <- terra::project(RASY,CRS('+proj=longlat +datum=WGS84'))
RASY <- crop(RASY, EcoZone)


# Another RASY - without SPI

#RASY
RASY <- vect(paste0(here("Inputs","AmphibianLocations"),"/RASY_Total_2nd.shp"))
RASY <- terra::project(RASY,"EPSG:4326")
#RASY <- terra::project(RASY,"EPSG:32610")

# BiodiversityR approach to spatially thin the records
RASYg <- data.frame(crds(RASY))
RASYgdf <- SpatialPointsDataFrame(coords = RASYg[,c(1,2)], data = RASYg,
                               proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)

system.time({
RASYgt <- ensemble.spatialThin.quant(RASYg,
                               thin.km = 1,
                               runs = 100,
                               silent = TRUE,
                               verbose = TRUE)

})
stopCluster(my.cluster)

RASYmat <- as.matrix(crds(RASY))
crspoints <- "+proj=longlat +datum=WGS84"
RASY_pts <- vect(RASYmat, crs = crspoints)
RASY_pts$ID <- RASY$ID
RASY_pts_s <- sf::st_as_sf(RASY_pts)

RASYgt_mat <- as.matrix(RASYgt)
RASYgt_pt <- vect(RASYgt_mat, crs = crspoints)
RASYgt_pt_s <- sf::st_as_sf(RASYgt_pt)


df_near <- st_join(RASYgt_pt_s, RASY_pts_s, join = st_nearest_feature)
RASY_join <- vect(df_near)
#RASY <- terra::project(RASY,CRS('+proj=longlat +datum=WGS84'))
RASY <- crop(RASY, EcoZone)


# Buffer the points by 1 km
AMMA_1km <- buffer(AMMA,
                   1000)
AMTI_1km <- buffer(AMTI,
                   1000)
ANBO_1km <- buffer(ANBO,
                   1000)
RALU_1km <- buffer(RALU,
                   1000)
RASY_1km <- buffer(RASY,
                   1000)


```


# Explanatory Variables

Review of variables in Muths et al. (2017) to consider variables for models.

Lucid and Cushman (2020) Northwest Naturalist, 104:281-286
Mean annual minimum air temperature

Derived annual variables:
Directly calculated annual variables:
MAT	 	mean annual temperature (°C),
MWMT 	mean warmest month temperature (°C),
MCMT  mean coldest month temperature (°C),

Derived seasonal variables:
RH_wt		winter relative humidity (%)

3) Monthly variables
Primary monthly variables:
TMN01 – TMN12 	January - December minimum mean temperatures (°C)


```{r, Explanatory_Vars, echo=FALSE}

# Shapefiles
EcoZone <- terra::project(EcoZone,"EPSG:32610")
Boreal <- EcoZone[1] # Boreal
Montane <- EcoZone[2] # Montane
Taiga <- EcoZone[3] # Taiga

CDEM_Total <- rast(paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_Total.tif"))
CDEM_Total <- terra::project(CDEM_Total,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(CDEM_Total) <- "Elev"

writeRaster(CDEM_Total,
            paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_Total.tif"),
            overwrite=TRUE)


CDEM_boreal <- rast(paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_boreal.asc"))
CDEM_boreal <- terra::project(CDEM_boreal,
                       "EPSG:32610",
                      threads=n.cores,
                      filename=paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_boreal.tif"),
                      overwrite=TRUE,
                      res=250)

CDEM_montane <- rast(paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_montane.asc"))
CDEM_montane <- terra::project(CDEM_montane,
                       "EPSG:32610",
                      threads=n.cores,
                      filename=paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_montane.tif"),
                      overwrite=TRUE,
                      res=250)

CDEM_taiga <- rast(paste0(here("Outputs","Rasters","Explanatory"),
                   "/CDEM_taiga.asc"))
CDEM_taiga <- terra::project(CDEM_taiga,
                       "EPSG:32610",
                      threads=n.cores,
                      filename=paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/CDEM_taiga.tif"),
                      overwrite=TRUE,
                      res=250)

# Roughness
Rough_dem <- terrain(CDEM_Total, "roughness")

names(Rough_dem) <- "Rough"

writeRaster(Rough_dem,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/Rough_dem.tif"),
            overwrite=TRUE)


# Slope
Slope_dem <- terrain(CDEM_Total, "slope")
names(Slope_dem) <- "Slope_vals"
writeRaster(Slope_dem, paste0(here("Inputs","Rasters",
                        "Explanatory"),"/Slope_dem.tif"), overwrite=TRUE)


# aspect
Aspect_dem <- terrain(CDEM_Total, "aspect")
names(Aspect_dem) <- "aspect"
writeRaster(Aspect_dem, paste0(here("Inputs","Rasters",
                        "Explanatory"),"/Aspect_dem.tif"), overwrite=TRUE)


# Slope-Aspect
SA_dem <- Slope_dem*Aspect_dem
names(SA_dem) <- "SA"
writeRaster(Aspect_dem, paste0(here("Inputs","Rasters",
                        "Explanatory"),"/SA_dem.tif"), overwrite=TRUE)



# Climate Variables
# Mean annual temperature
Boreal_MAT <- rast(paste0(here("Outputs",
                              "Rasters",
                              "Explanatory",
                              "CDEM_boreal",
                              "Normal_1991_2020Y"),
                          "/MAT.asc"))

Boreal_MAT <- terra::project(Boreal_MAT,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(Boreal_MAT) <- "MAT"

writeRaster(Boreal_MAT,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/Boreal_MAT.tif"),
            overwrite=TRUE)



Montane_MAT <- rast(paste0(here("Outputs",
                              "Rasters",
                              "Explanatory",
                              "CDEM_montane",
                              "Normal_1991_2020Y"),
                          "/MAT.asc"))

Montane_MAT <- terra::project(Montane_MAT,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(Montane_MAT) <- "MAT"
writeRaster(Montane_MAT,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/Montane_MAT.tif"),
            overwrite=TRUE)


Taiga_MAT <- rast(paste0(here("Outputs",
                              "Rasters",
                              "Explanatory",
                              "CDEM_taiga",
                              "Normal_1991_2020Y"),
                          "/MAT.asc"))

Taiga_MAT <- terra::project(Taiga_MAT,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(Taiga_MAT) <- "MAT"
writeRaster(Taiga_MAT,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/Taiga_MAT.tif"),
            overwrite=TRUE)

# mean coldest month temperature (°C),
# MCMT  

Boreal_MCMT <- rast(paste0(here("Outputs",
                              "Rasters",
                              "Explanatory",
                              "CDEM_boreal",
                              "Normal_1991_2020Y"),
                          "/MCMT.asc"))

Boreal_MCMT <- terra::project(Boreal_MCMT,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(Boreal_MCMT) <- "MCMT"
writeRaster(Boreal_MCMT,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/Boreal_MCMT.tif"),
            overwrite=TRUE)



Montane_MCMT <- rast(paste0(here("Outputs",
                              "Rasters",
                              "Explanatory",
                              "CDEM_montane",
                              "Normal_1991_2020Y"),
                          "/MCMT.asc"))

Montane_MCMT <- terra::project(Montane_MCMT,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(Montane_MCMT) <- "MCMT"
writeRaster(Montane_MCMT,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/Montane_MCMT.tif"),
            overwrite=TRUE)


Taiga_MCMT <- rast(paste0(here("Outputs",
                              "Rasters",
                              "Explanatory",
                              "CDEM_taiga",
                              "Normal_1991_2020Y"),
                          "/MCMT.asc"))

Taiga_MCMT <- terra::project(Taiga_MCMT,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(Taiga_MCMT) <- "MCMT"
writeRaster(Taiga_MCMT,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/Taiga_MCMT.tif"),
            overwrite=TRUE)


## NDVI:

NDVI <- rast(paste0(here::here("Inputs",
                                     "Rasters",
                                     "Explanatory"),
                          "/MODIS_FULL.tif"))

NDVI <- terra::project(NDVI,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(NDVI) <- "NDVI"

writeRaster(NDVI,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/NDVI.tif"),
            overwrite=TRUE)

## Land Cover

LandCov <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/LandCov.tif"))

LandCov <- terra::project(LandCov,
                       "EPSG:32610",
                      threads=n.cores,
                      res=250)
names(LandCov) <- "LandCov"

writeRaster(LandCov,
            paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/LandCov.tif"),
            overwrite=TRUE)


```

# SpatRasters to RF Sprasts

```{r Sprasts, echo=FALSE, eval=FALSE}

# Shapefiles
EcoZone <- terra::project(EcoZone,"EPSG:32610")
Boreal <- EcoZone[1] # Boreal
Montane <- EcoZone[2] # Montane
Taiga <- EcoZone[3] # Taiga

# CDEM

CDEM_Total <- rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/CDEM_Total.tif"))
CDEM_boreal <-rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/CDEM_boreal.tif"))
CDEM_montane <-rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/CDEM_montane.tif"))
CDEM_taiga <-rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/CDEM_taiga.tif"))

#Roughness
Rough_dem <- rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/Rough_dem.tif"))
Rough_boreal <- crop(Rough_dem,Boreal)
Rough_boreal <- mask(Rough_boreal,Boreal)
Rough_montane <- crop(Rough_dem,Montane)
Rough_montane <- mask(Rough_montane,Montane)
Rough_taiga <- crop(Rough_dem,Taiga)
Rough_taiga <- mask(Rough_taiga,Taiga)

#Slope_Aspect
SA_dem <- rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/SA_dem.tif"))
SA_boreal <- crop(SA_dem,Boreal)
SA_boreal <- mask(SA_boreal,Boreal)

SA_montane <- crop(SA_dem,Montane)
SA_montane <- mask(SA_montane,Montane)

SA_taiga <- crop(SA_dem,Taiga)
SA_taiga <- mask(SA_taiga,Taiga)

#NDVI
NDVI <-rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/NDVI.tif")) 
NDVI_boreal <- crop(NDVI,Boreal)
NDVI_boreal <- mask(NDVI_boreal,Boreal)

NDVI_montane <- crop(NDVI,Montane)
NDVI_montane <- mask(NDVI_montane,Montane)

NDVI_taiga <- crop(NDVI,Taiga)
NDVI_taiga <- mask(NDVI_taiga,Taiga)

#LandCov
LandCov <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/LandCov.tif"))
LandCov_boreal <- crop(LandCov,Boreal)
LandCov_boreal <- mask(LandCov_boreal,Boreal)

LandCov_montane <- crop(LandCov,Montane)
LandCov_montane <- mask(LandCov_montane,Montane)

LandCov_taiga <- crop(LandCov,Taiga)
LandCov_taiga <- mask(LandCov_taiga,Taiga)

# MAT
Boreal_MAT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Boreal_MAT.tif"))
Montane_MAT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Montane_MAT.tif"))
Taiga_MAT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Taiga_MAT.tif"))

# MCMT
Boreal_MCMT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Boreal_MCMT.tif"))

Montane_MCMT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Montane_MCMT.tif"))

Taiga_MCMT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Taiga_MCMT.tif"))

# Some have slightly different origins.
# resample - see:
# https://gis.stackexchange.com/questions/440245

blankras <- NDVI_boreal
blankras[blankras > min(values(blankras),na.rm=TRUE)] <- 1
blankras[blankras < max(values(blankras),na.rm=TRUE)] <- 1

CDEM_boreal <- resample(CDEM_boreal,blankras)
CDEM_boreal <- mask(CDEM_boreal,blankras)

Boreal_MAT  <- resample(Boreal_MAT,blankras)
Boreal_MAT <- mask(Boreal_MAT,blankras)

Boreal_MCMT <- resample(Boreal_MCMT,blankras)
Boreal_MCMT <- mask(Boreal_MCMT,blankras)

SA_boreal <- resample(SA_boreal,blankras)
SA_boreal <- mask(SA_boreal,Rough_boreal)

NDVI_boreal <- resample(NDVI_boreal,blankras)
NDVI_boreal <- mask(NDVI_boreal,blankras)

LandCov_boreal <- resample(LandCov_boreal,blankras)
LandCov_boreal <- mask(LandCov_boreal,blankras)

Sprasts_boreal <- c(CDEM_boreal,
                    Rough_boreal,
                    SA_boreal,
                    NDVI_boreal,
                    LandCov_boreal,
                    Boreal_MAT,
                    Boreal_MCMT
                    )

# Montane

blankras <- NDVI_montane
blankras[blankras > min(values(blankras),na.rm=TRUE)] <- 1
blankras[blankras < max(values(blankras),na.rm=TRUE)] <- 1

CDEM_montane <- resample(CDEM_montane,blankras)
CDEM_montane <- mask(CDEM_montane,blankras)

Montane_MAT  <- resample(Montane_MAT,blankras)
Montane_MAT <- mask(Montane_MAT,blankras)

Montane_MCMT <- resample(Montane_MCMT,blankras)
Montane_MCMT <- mask(Montane_MCMT,blankras)

SA_montane <- resample(SA_montane,blankras)
SA_montane <- mask(SA_montane,blankras)

NDVI_montane <- resample(NDVI_montane,blankras)
NDVI_montane <- mask(NDVI_montane,blankras)

LandCov_montane <- resample(LandCov_montane,blankras)
LandCov_montane <- mask(LandCov_montane,blankras)

Sprasts_montane <- c(CDEM_montane,
                    Rough_montane,
                    SA_montane,
                    NDVI_montane,
                    LandCov_montane,
                    Montane_MAT,
                    Montane_MCMT
                    )

# Taiga

blankras <- NDVI_taiga
blankras[blankras > min(values(blankras),na.rm=TRUE)] <- 1
blankras[blankras < max(values(blankras),na.rm=TRUE)] <- 1

CDEM_taiga <- resample(CDEM_taiga,blankras)
CDEM_taiga <- mask(CDEM_taiga,blankras)

Taiga_MAT  <- resample(Taiga_MAT,blankras)
Taiga_MAT <- mask(Taiga_MAT,blankras)

Taiga_MCMT <- resample(Taiga_MCMT,blankras)
Taiga_MCMT <- mask(Taiga_MCMT,blankras)

SA_taiga <- resample(SA_taiga,blankras)
SA_taiga <- mask(SA_taiga,blankras)

NDVI_taiga <- resample(NDVI_taiga,blankras)
NDVI_taiga <- mask(NDVI_taiga,blankras)

LandCov_taiga <- resample(LandCov_taiga,blankras)
LandCov_taiga <- mask(LandCov_taiga,blankras)

Sprasts_taiga <- c(CDEM_taiga,
                    Rough_taiga,
                    SA_taiga,
                    NDVI_taiga,
                    LandCov_taiga,
                    Taiga_MAT,
                    Taiga_MCMT
                    )

```


# Pseudo-absent data

I originally started with PseuAbs rstats package, that was developed by:

Descombes, P., Chauvier, Y., Brun, P., Righetti, D., Wüest, R.O., Karger, D.N., Zurell, D. & Zimmermann, N.E. (2022). Strategies for sampling pseudo-absences for species distribution models in complex mountainous terrain. bioRxiv, 2022.03.24.485693.

The source code was reviewed through the GitHub source:

https://github.com/filBe87/PseuAbs/blob/0744d9a753d570524140b0182f9e33e99d1a4585/R/wsl_samplePseuAbs.R

There are three pseu.abs samples that are varied by the "add.strat = x" parameters. The value equals the proportion of pseudo samples that are sampled out of the stratification. So a setting of 0.2 will mean that 20% of the psdeuo-absences are randomly sampled within strata and 80% are randomly sampled without stratification. In contrast, a setting of 0.8 produces a more clumped psdeuo-absence sampling distribution within the strata with 20% sampling into areas outside of what might be expected as suitable habitat. A setting of 0.8 is selected for the model used, but other values can be tested. Note also that I use "presence", which includes only 33 of the original 66 known points. These were trimmed to include only points that exist within a vegetation pixel that was not classified with a "NA" value. The vegetation "NA" pixels can be filled in using other remote sensing data, such as a radar based NDVI. However, some of the values are "NA" by chance and this adds a layer of uncertainty in the input data. Adding uncertainty in the input data can improve on the predictability of the model. The PseuAbs package removes presence data in the sampling process.

The current explanatory rasters include:

Taiga_ExpRas <- c("CDEM_taiga","Rough_taiga","SA_taiga","NDVI_taiga","LandCov_taiga","Taiga_MAT","Taiga_MCMT")


PseuAbs approach - not published yet.
pseu.abs = wsl.samplePseuAbs(type="random",
                            n=5000,
                            env.stack=Sprasts_boreal,
                            template_dir=here::here("Stratification"),
                            pres=AMMA_pres,
                            geores_fact=3,
                            add.strat=0.8,
                            env.strat_path=here::here("Stratification"),
                            force_spat_thin='presences'
                            )

I shifted to dismo package approach:https://rspatial.org/raster/sdm/3_sdm_absence-background.html


```{r Pseudo_Abs, echo=FALSE, eval=FALSE}

# Original data in latlon per dismo style

#AMMA <- vect(paste0(here("Inputs","AmphibianLocations"),"/AMMA_Total.shp"))
# EcoZone needs to be latlon for this chunk

EcoZone <- terra::project(EcoZone,"epsg:4326")

#AMMA <- crop(AMMA,EcoZone)
# AMMA CRS needs to be latlon for this
AMMA2 <- terra::project(AMMA, "epsg:4326")
AMMA_pres <- as.data.frame(geom(AMMA2))
AMMA_pres <- AMMA_pres[,c(3:4)]
AMMA_pres$ID = paste0("T",1:nrow(AMMA_pres))
AMMA_pres <- AMMA_pres[,c(3,1:2)]
AMMA_pres$PA <- 1
names(AMMA_pres) <- c("ID","lat","lon","PA")

# Dismo
AMMA_presd <- AMMA_pres
coordinates(AMMA_presd) <- ~lat+lon

# circles with a radius of 50 km
x <- circles(AMMA_presd, d=50000, lonlat=TRUE)
pol <- polygons(x)

# sample randomly from all circles
AMMA_Pseudo1 <- spsample(pol, nrow(AMMA_presd), type='stratified', iter=25)
AMMA_abs <- as.data.frame(geom(AMMA_Pseudo1))
AMMA_abs$ID = paste0("F",1:nrow(AMMA_abs))
AMMA_abs <- AMMA_abs[,c(4,2:3)]
AMMA_abs$PA <- 0
names(AMMA_abs) <- c("ID","lat","lon","PA")


#AMTI
AMTI <- vect(paste0(here("Inputs","AmphibianLocations"),"/AMTI_Total.shp"))
AMTI <- crop(AMTI,EcoZone)
AMTI2 <- terra::project(AMTI, "epsg:4326")


AMTI_pres <- as.data.frame(geom(AMTI2))
AMTI_pres <- AMTI_pres[,c(3:4)]
AMTI_pres$ID = paste0("T",1:nrow(AMTI_pres))
AMTI_pres <- AMTI_pres[,c(3,1:2)]
AMTI_pres$PA <- 1
names(AMTI_pres) <- c("ID","lat","lon","PA")

# Dismo
AMTI_presd <- AMTI_pres
coordinates(AMTI_presd) <- ~lat+lon
projection(AMTI_presd) <- CRS('+proj=longlat +datum=WGS84')

# circles with a radius of 50 km
x <- circles(AMTI_presd, d=50000, lonlat=TRUE)
pol <- polygons(x)

# sample randomly from all circles
# Sampling AMTI extra
AMTI_Pseudo1 <- spsample(pol, nrow(AMTI_presd), type='stratified', iter=25)
AMTI_abs <- as.data.frame(geom(AMTI_Pseudo1))
AMTI_abs$ID = paste0("F",1:nrow(AMTI_abs))
AMTI_abs <- AMTI_abs[,c(4,2:3)]
AMTI_abs$PA <- 0
names(AMTI_abs) <- c("ID","lat","lon","PA")

# ANBO
ANBO <- vect(paste0(here("Inputs","AmphibianLocations"),"/ANBO_Total.shp"))
ANBO <- crop(ANBO,EcoZone)
ANBO2 <- terra::project(ANBO, "epsg:4326")

ANBO_pres <- as.data.frame(geom(ANBO2))
ANBO_pres <- ANBO_pres[,c(3:4)]
ANBO_pres$ID = paste0("T",1:nrow(ANBO_pres))
ANBO_pres <- ANBO_pres[,c(3,1:2)]
ANBO_pres$PA <- 1
names(ANBO_pres) <- c("ID","lat","lon","PA")

# Dismo
ANBO_presd <- ANBO_pres
coordinates(ANBO_presd) <- ~lat+lon
projection(ANBO_presd) <- CRS('+proj=longlat +datum=WGS84')

# circles with a radius of 50 km
x <- circles(ANBO_presd, d=50000, lonlat=TRUE)
pol <- polygons(x)

# sample randomly from all circles
ANBO_Pseudo1 <- spsample(pol, nrow(ANBO_presd)/25, type='stratified', iter=25)
ANBO_abs <- as.data.frame(geom(ANBO_Pseudo1))
ANBO_abs$ID = paste0("F",1:nrow(ANBO_abs))
ANBO_abs <- ANBO_abs[,c(4,2:3)]
ANBO_abs$PA <- 0
names(ANBO_abs) <- c("ID","lat","lon","PA")

# RASY
RASY <- vect(paste0(here("Inputs","AmphibianLocations"),"/RASY_Total_2nd.shp"))
RASY <- terra::project(RASY,  CRS('+proj=longlat +datum=WGS84'))
RASY <- crop(RASY,EcoZone)
RASY2 <- terra::project(RASY, "epsg:4326")

RASY_pres <- as.data.frame(geom(RASY2))
RASY_pres <- RASY_pres[,c(3:4)]
RASY_pres$ID = paste0("T",1:nrow(RASY_pres))
RASY_pres <- RASY_pres[,c(3,1:2)]
RASY_pres$PA <- 1
names(RASY_pres) <- c("ID","lat","lon","PA")

# Dismo
RASY_presd <- RASY_pres
coordinates(RASY_presd) <- ~lat+lon
projection(RASY_presd) <- CRS('+proj=longlat +datum=WGS84')

# circles with a radius of 50 km
x <- circles(RASY_presd, d=50000, lonlat=TRUE)
pol <- polygons(x)

# sample randomly from all circles
RASY_Pseudo1 <- spsample(pol, nrow(RASY_presd), type='stratified', iter=25)
RASY_abs <- as.data.frame(geom(RASY_Pseudo1))
RASY_abs$ID = paste0("F",1:nrow(RASY_abs))
RASY_abs <- RASY_abs[,c(4,2:3)]
RASY_abs$PA <- 0
names(RASY_abs) <- c("ID","lat","lon","PA")

# RALU
RALU <- vect(paste0(here("Inputs","AmphibianLocations"),"/RALU_Total.shp"))
RALU <- terra::project(RALU,  CRS('+proj=longlat +datum=WGS84'))
RALU <- crop(RALU,EcoZone)
RALU2 <- terra::project(RALU, "epsg:4326")

RALU_pres <- as.data.frame(geom(RALU2))
RALU_pres <- RALU_pres[,c(3:4)]
RALU_pres$ID = paste0("T",1:nrow(RALU_pres))
RALU_pres <- RALU_pres[,c(3,1:2)]
RALU_pres$PA <- 1
names(RALU_pres) <- c("ID","lat","lon","PA")

# Dismo
RALU_presd <- RALU_pres
coordinates(RALU_presd) <- ~lat+lon
projection(RALU_presd) <- CRS('+proj=longlat +datum=WGS84')

# circles with a radius of 50 km
x <- circles(RALU_presd, d=50000, lonlat=TRUE)
pol <- polygons(x)

# sample randomly from all circles
RALU_Pseudo1 <- spsample(pol, nrow(RALU_presd)/25, type='stratified', iter=25)
RALU_abs <- as.data.frame(geom(RALU_Pseudo1))
RALU_abs$ID = paste0("F",1:nrow(RALU_abs))
RALU_abs <- RALU_abs[,c(4,2:3)]
RALU_abs$PA <- 0
names(RALU_abs) <- c("ID","lat","lon","PA")

# Buffer the points by 1 km
AMMA_Pseudo1 <- terra::crop(vect(AMMA_Pseudo1), ext(EcoZone))
AMMA_Pseudo1$ID <- paste0("F",1:nrow(AMMA_Pseudo1)) 

AMTI_Pseudo1 <- crop(vect(AMTI_Pseudo1), ext(EcoZone))
AMTI_Pseudo1$ID <- paste0("F",1:nrow(AMTI_Pseudo1)) 

ANBO_Pseudo1 <- crop(vect(ANBO_Pseudo1), ext(EcoZone))
ANBO_Pseudo1$ID <- paste0("F",1:nrow(ANBO_Pseudo1)) 

RALU_Pseudo1 <- crop(vect(RALU_Pseudo1), ext(EcoZone))
RALU_Pseudo1$ID <- paste0("F",1:nrow(RALU_Pseudo1)) 

RASY_Pseudo1 <- crop(vect(RASY_Pseudo1), ext(EcoZone))
RASY_Pseudo1$ID <- paste0("F",1:nrow(RASY_Pseudo1)) 

AMMA_Pseudo1_1km <- buffer(AMMA_Pseudo1,
                   1000)
AMTI_Pseudo1_1km <- buffer(AMTI_Pseudo1,
                   1000)
ANBO_Pseudo1_1km <- buffer(ANBO_Pseudo1,
                   1000)
RALU_Pseudo1_1km <- buffer(RALU_Pseudo1,
                   1000)
RASY_Pseudo1_1km <- buffer(RASY_Pseudo1,
                   1000)

```

# Random Forest models

I have sampled the median value for all explanatory rasters 1 km around known points and the pseudo absence points.

AMMA <- Ambystoma macrodactylum
AMTI <- Ambystoma tigrinum
ANBO <- Anaxyrus boreas
RASY <- Rana sylvatica
RALU <- Rana luteiventris

I could have made my life easier by putting everything into a list, but I like to print everything out separately for the manual inspection of the RF plots.


```{r RF_Stat, echo=TRUE, eval=FALSE}

# Put EcoZone back into UTM
EcoZone <- terra::project(EcoZone,"EPSG:32610")

# Start AMMA - True Record
AMMA_1km$ID <- AMMA_pres$ID
AMMA_1km_montane <- crop(AMMA_1km, terra::project(Montane, crs(AMMA_1km)))

# Extract the median values - True Records
Montane_AMMA_T <- terra::extract(Sprasts_montane,
             fun="median",
             method="bilinear",
             AMMA_1km_montane,
             na.rm=TRUE)

AMMA_1km_montane$ID <- paste0("T",Montane_AMMA_T$ID)
Montane_AMMA_T$ID <- AMMA_1km_montane$ID
AMMA_1km_montane <- AMMA_1km_montane[,85]
Montane_AMMA_T$PA <- 1

# Pseudo AMMA
AMMA_Pseudo1_1km <- terra::project(AMMA_Pseudo1_1km, Montane)
AMMA_F_1km_montane <- crop(AMMA_Pseudo1_1km, Montane)

AMMA_F_1km_montane$ID <- AMMA_Pseudo1$ID
AMMA_F_1km_montane <- crop(AMMA_Pseudo1_1km, Montane)


# Extract the median values - Pseudo Records
Montane_AMMA_F <- terra::extract(Sprasts_montane,
             fun="median",
             method="bilinear",
             AMMA_F_1km_montane,
             na.rm=FALSE)

Montane_AMMA_F$ID <- AMMA_F_1km_montane$ID
Montane_AMMA_F$PA <- 0

Montane_AMMA_T2 <- merge(Montane_AMMA_T,AMMA_pres,by=c("ID","PA"))
Montane_AMMA_F2 <- merge(Montane_AMMA_F,AMMA_abs,by=c("ID","PA"))

AMMA_data <- rbind(Montane_AMMA_T2,Montane_AMMA_F2)
AMMA_data <- na.omit(AMMA_data)
names(AMMA_data) <- c("ID", "PA", "elev", "Rough", "SA", "NDVI", "LC", "MAT", "MCMT", "lat", "lon")
names(Sprasts_montane) <- c("elev","Rough","SA","NDVI","LC","MAT","MCMT")
AMMA_data$PA <- as.numeric(AMMA_data$PA)

## AMMA ----
AMMA_rfm <- randomForest(formula=PA ~ elev + Rough + SA + NDVI + LC + MAT + MCMT, data=AMMA_data)

result <- rfcv(AMMA_data[,c(3:9)],AMMA_data$PA,scale="log",step=0.7)
with(result, plot(n.var, error.cv, log="x", type="o", lwd=2))

print(AMMA_rfm)
floor(sqrt(ncol(AMMA_data) - 1))

AMMA_rfmtry <- tuneRF(AMMA_data[-1],AMMA_data$PA, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- AMMA_rfmtry[AMMA_rfmtry[, 2] == min(AMMA_rfmtry[, 2]), 1]
print(AMMA_rfmtry)

set.seed(71)
AMMA_rfm2 <-randomForest(PA~.,data=AMMA_data[,c(2:9)], mtry=best.m, importance=TRUE,ntree=500)
print(AMMA_rfm2)

#Evaluate variable importance
randomForest::importance(AMMA_rfm2)
varImpPlot(AMMA_rfm2)

AMMA_rfm2 <-randomForest(PA~.,data=AMMA_data, mtry=best.m, importance=TRUE,ntree=500)

# All but LC, NDVI, SA
AMMA_rfm3 <-randomForest(PA~MAT+MCMT+Rough+elev+LC, data=AMMA_data)
print(AMMA_rfm3)

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)

system.time({
AMMA_montane_mod <- predict(Sprasts_montane, AMMA_rfm3)
})
stopCluster(my.cluster)

writeRaster(AMMA_montane_mod,paste0(here("Outputs","Predictions"),"/AMMA_montane_RFmod_red.tif"), overwrite=TRUE)

## AMMA - Boreal
# Start AMMA - True Record
AMMA_1km$ID <- AMMA_pres$ID
AMMA_1km_boreal <- crop(AMMA_1km, terra::project(Boreal,crs(AMMA_1km)))

# Extract the median values - True Records
Boreal_AMMA_T <- terra::extract(Sprasts_boreal,
             fun="median",
             method="bilinear",
             AMMA_1km_boreal,
             na.rm=TRUE)

AMMA_1km_boreal$ID <- paste0("T",Boreal_AMMA_T$ID)
Boreal_AMMA_T$ID <- AMMA_1km_boreal$ID
AMMA_1km_boreal <- AMMA_1km_boreal[,85]
Boreal_AMMA_T$PA <- 1

# Pseudo AMMA
AMMA_Pseudo1_1km <- terra::project(AMMA_Pseudo1_1km, Boreal)
AMMA_F_1km_boreal <- crop(AMMA_Pseudo1_1km, Boreal)

AMMA_F_1km_boreal$ID <- AMMA_Pseudo1$ID
AMMA_F_1km_boreal <- crop(AMMA_Pseudo1_1km, Boreal)

# Extract the median values - Pseudo Records
Boreal_AMMA_F <- terra::extract(Sprasts_boreal,
             fun="median",
             method="bilinear",
             AMMA_F_1km_boreal,
             na.rm=FALSE)

Boreal_AMMA_F$ID <- AMMA_F_1km_boreal$ID
Boreal_AMMA_F$PA <- 0

Boreal_AMMA_T2 <- merge(Boreal_AMMA_T,AMMA_pres,by=c("ID","PA"))
Boreal_AMMA_F2 <- merge(Boreal_AMMA_F,AMMA_abs,by=c("ID","PA"))

AMMA_data <- rbind(Boreal_AMMA_T2,Boreal_AMMA_F2)
AMMA_data <- na.omit(AMMA_data)
names(AMMA_data) <- c("ID", "PA", "elev", "Rough", "SA", "NDVI", "LC", "MAT", "MCMT", "lat", "lon")
names(Sprasts_boreal) <- c("elev","Rough","SA","NDVI","LC","MAT","MCMT")
AMMA_data$PA <- as.numeric(AMMA_data$PA)

## AMMA ----
AMMA_rfm <- randomForest(formula=PA ~ elev + Rough + SA + NDVI + LC + MAT + MCMT, data=AMMA_data)

result <- rfcv(AMMA_data[,c(3:9)],AMMA_data$PA,scale="log",step=0.7)
with(result, plot(n.var, error.cv, log="x", type="o", lwd=2))

print(AMMA_rfm)
floor(sqrt(ncol(AMMA_data) - 1))

AMMA_rfmtry <- tuneRF(AMMA_data[-1],AMMA_data$PA, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- AMMA_rfmtry[AMMA_rfmtry[, 2] == min(AMMA_rfmtry[, 2]), 1]
print(AMMA_rfmtry)

set.seed(71)
AMMA_rfm2 <-randomForest(PA~.,data=AMMA_data[,c(2:9)], mtry=best.m, importance=TRUE,ntree=500)
print(AMMA_rfm2)
#Evaluate variable importance
randomForest::importance(AMMA_rfm2)
varImpPlot(AMMA_rfm2)

# Reduce to 4 variables:
# elev, MAT, NDVI, LC
AMMA_rfm3 <-randomForest(PA~MAT+elev+Rough, data=AMMA_data)
print(AMMA_rfm3)

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)

system.time({
AMMA_boreal_mod <- predict(Sprasts_boreal, AMMA_rfm3)
})
stopCluster(my.cluster)

writeRaster(AMMA_boreal_mod,paste0(here("Outputs","Predictions"),"/AMMA_boreal_RFmod_red.tif"), overwrite=TRUE)

## ANBO
# Start ANBO - True Record
ANBO_1km$ID <- ANBO_pres$ID
ANBO_1km_montane <- crop(terra::project(ANBO_1km,"EPSG:32610"), Montane)

# Extract the median values - True Records
Montane_ANBO_T <- terra::extract(Sprasts_montane,
             fun="median",
             method="bilinear",
             ANBO_1km_montane,
             na.rm=TRUE)

ANBO_1km_montane$ID <- paste0("T",Montane_ANBO_T$ID)
Montane_ANBO_T$ID <- ANBO_1km_montane$ID
ANBO_1km_montane <- ANBO_1km_montane[,85]
Montane_ANBO_T$PA <- 1

# Pseudo ANBO
ANBO_Pseudo1_1km <- terra::project(ANBO_Pseudo1_1km, Montane)
ANBO_F_1km_montane <- crop(ANBO_Pseudo1_1km, Montane)

ANBO_F_1km_montane$ID <- ANBO_Pseudo1$ID
ANBO_F_1km_montane <- crop(ANBO_Pseudo1_1km, Montane)


# Extract the median values - Pseudo Records
Montane_ANBO_F <- terra::extract(Sprasts_montane,
             fun="median",
             method="bilinear",
             ANBO_F_1km_montane,
             na.rm=FALSE)

Montane_ANBO_F$ID <- ANBO_F_1km_montane$ID
Montane_ANBO_F$PA <- 0

Montane_ANBO_T2 <- merge(Montane_ANBO_T,ANBO_pres,by=c("ID","PA"))
Montane_ANBO_F2 <- merge(Montane_ANBO_F,ANBO_abs,by=c("ID","PA"))

ANBO_data <- rbind(Montane_ANBO_T2,Montane_ANBO_F2)
ANBO_data <- na.omit(ANBO_data)
names(ANBO_data) <- c("ID", "PA", "elev", "Rough", "SA", "NDVI", "LC", "MAT", "MCMT", "lat", "lon")
names(Sprasts_montane) <- c("elev","Rough","SA","NDVI","LC","MAT","MCMT")
ANBO_data$PA <- as.numeric(ANBO_data$PA)

## ANBO ----
ANBO_rfm <- randomForest(formula=PA ~ elev + Rough + SA + NDVI + LC + MAT + MCMT, data=ANBO_data)

result <- rfcv(ANBO_data[,c(3:9)],ANBO_data$PA,scale="log",step=0.7)
with(result, plot(n.var, error.cv, log="x", type="o", lwd=2))

print(ANBO_rfm)
floor(sqrt(ncol(ANBO_data) - 1))

ANBO_rfmtry <- tuneRF(ANBO_data[-1],ANBO_data$PA, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- ANBO_rfmtry[ANBO_rfmtry[, 2] == min(ANBO_rfmtry[, 2]), 1]
print(ANBO_rfmtry)

set.seed(71)
ANBO_rfm2 <-randomForest(PA~.,data=ANBO_data[,c(2:9)], mtry=best.m, importance=TRUE,ntree=500)
print(ANBO_rfm2)

#Evaluate variable importance
randomForest::importance(ANBO_rfm2)
varImpPlot(ANBO_rfm2)

# Reduce to x variables:
# All the variables seem ok - very low OOB err
ANBO_rfm3 <-randomForest(PA~Rough+SA+LC+NDVI+MAT+elev, data=ANBO_data)
print(ANBO_rfm3)

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)

system.time({
ANBO_montane_mod <- predict(Sprasts_montane, ANBO_rfm)
})
stopCluster(my.cluster)

writeRaster(ANBO_montane_mod,paste0(here("Outputs","Predictions"),"/ANBO_montane_RFmod_red.tif"), overwrite=TRUE)

## ANBO - Boreal
# Start ANBO - True Record
ANBO_1km$ID <- ANBO_pres$ID
ANBO_1km_boreal <- crop(terra::project(ANBO_1km,"EPSG:32610"), Boreal)

# Extract the median values - True Records
Boreal_ANBO_T <- terra::extract(Sprasts_boreal,
             fun="median",
             method="bilinear",
             ANBO_1km_boreal,
             na.rm=TRUE)

ANBO_1km_boreal$ID <- paste0("T",Boreal_ANBO_T$ID)
Boreal_ANBO_T$ID <- ANBO_1km_boreal$ID
ANBO_1km_boreal <- ANBO_1km_boreal[,85]
Boreal_ANBO_T$PA <- 1

# Pseudo ANBO
ANBO_Pseudo1_1km <- terra::project(ANBO_Pseudo1_1km, Boreal)
ANBO_F_1km_boreal <- crop(ANBO_Pseudo1_1km, Boreal)

ANBO_F_1km_boreal$ID <- ANBO_Pseudo1$ID
ANBO_F_1km_boreal <- crop(ANBO_Pseudo1_1km, Boreal)

# Extract the median values - Pseudo Records
Boreal_ANBO_F <- terra::extract(Sprasts_boreal,
             fun="median",
             method="bilinear",
             ANBO_F_1km_boreal,
             na.rm=FALSE)

Boreal_ANBO_F$ID <- ANBO_F_1km_boreal$ID
Boreal_ANBO_F$PA <- 0

Boreal_ANBO_T2 <- merge(Boreal_ANBO_T,ANBO_pres,by=c("ID","PA"))
Boreal_ANBO_F2 <- merge(Boreal_ANBO_F,ANBO_abs,by=c("ID","PA"))

ANBO_data <- rbind(Boreal_ANBO_T2,Boreal_ANBO_F2)
ANBO_data <- na.omit(ANBO_data)

names(ANBO_data) <- c("ID", "PA", "elev", "Rough", "SA", "NDVI", "LC", "MAT", "MCMT", "lat", "lon")
names(Sprasts_boreal) <- c("elev","Rough","SA","NDVI","LC","MAT","MCMT")
ANBO_data$PA <- as.numeric(ANBO_data$PA)

## ANBO ----
ANBO_rfm <- randomForest(formula=PA ~ elev + Rough + SA + NDVI + LC + MAT + MCMT, data=ANBO_data)

result <- rfcv(ANBO_data[,c(3:9)],ANBO_data$PA,scale="log",step=0.7)
with(result, plot(n.var, error.cv, log="x", type="o", lwd=2))

print(ANBO_rfm)
floor(sqrt(ncol(ANBO_data) - 1))

ANBO_rfmtry <- tuneRF(ANBO_data[-1],ANBO_data$PA, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- ANBO_rfmtry[ANBO_rfmtry[, 2] == min(ANBO_rfmtry[, 2]), 1]
print(ANBO_rfmtry)

set.seed(71)
ANBO_rfm2 <-randomForest(PA~.,data=ANBO_data[,c(2:9)], mtry=best.m, importance=TRUE,ntree=500)
print(ANBO_rfm2)

#Evaluate variable importance
randomForest::importance(ANBO_rfm2)
varImpPlot(ANBO_rfm2)

# Reduce to x variables:
#  
ANBO_rfm3 <-randomForest(PA~elev + LC + Rough + MCMT, data=ANBO_data)
print(ANBO_rfm3)

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)

system.time({
ANBO_boreal_mod <- predict(Sprasts_boreal, ANBO_rfm3)
})
stopCluster(my.cluster)

writeRaster(ANBO_boreal_mod,paste0(here("Outputs","Predictions"),"/ANBO_boreal_RFmod_red.tif"), overwrite=TRUE)

## RALU
# Start RALU - True Record
RALU_1km$ID <- RALU_pres$ID
RALU_1km_montane <- crop(terra::project(RALU_1km, "EPSG:32610"), Montane)

# Extract the median values - True Records
Montane_RALU_T <- terra::extract(Sprasts_montane,
             fun="median",
             method="bilinear",
             RALU_1km_montane,
             na.rm=TRUE)

RALU_1km_montane$ID <- paste0("T",Montane_RALU_T$ID)
Montane_RALU_T$ID <- RALU_1km_montane$ID
RALU_1km_montane <- RALU_1km_montane[,85]
Montane_RALU_T$PA <- 1

# Pseudo RALU
RALU_Pseudo1_1km <- terra::project(RALU_Pseudo1_1km, Montane)
RALU_F_1km_montane <- crop(RALU_Pseudo1_1km, Montane)

RALU_F_1km_montane$ID <- RALU_Pseudo1$ID
RALU_F_1km_montane <- crop(RALU_Pseudo1_1km, Montane)


# Extract the median values - Pseudo Records
Montane_RALU_F <- terra::extract(Sprasts_montane,
             fun="median",
             method="bilinear",
             RALU_F_1km_montane,
             na.rm=FALSE)

Montane_RALU_F$ID <- RALU_F_1km_montane$ID
Montane_RALU_F$PA <- 0

Montane_RALU_T2 <- merge(Montane_RALU_T,RALU_pres,by=c("ID","PA"))
Montane_RALU_F2 <- merge(Montane_RALU_F,RALU_abs,by=c("ID","PA"))

RALU_data <- rbind(Montane_RALU_T2,Montane_RALU_F2)
RALU_data <- na.omit(RALU_data)
names(RALU_data) <- c("ID", "PA", "elev", "Rough", "SA", "NDVI", "LC", "MAT", "MCMT", "lat", "lon")
names(Sprasts_montane) <- c("elev","Rough","SA","NDVI","LC","MAT","MCMT")
RALU_data$PA <- as.numeric(RALU_data$PA)

## RALU ----
RALU_rfm <- randomForest(formula=PA ~ elev + Rough + SA + NDVI + LC + MAT + MCMT, data=RALU_data)

result <- rfcv(RALU_data[,c(3:9)],RALU_data$PA,scale="log",step=0.7)
with(result, plot(n.var, error.cv, log="x", type="o", lwd=2))

print(RALU_rfm)
floor(sqrt(ncol(RALU_data) - 1))

RALU_rfmtry <- tuneRF(RALU_data[-1],RALU_data$PA, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- RALU_rfmtry[RALU_rfmtry[, 2] == min(RALU_rfmtry[, 2]), 1]
print(RALU_rfmtry)

set.seed(71)
RALU_rfm2 <-randomForest(PA~.,data=RALU_data[,c(2:9)], mtry=best.m, importance=TRUE,ntree=500)
print(RALU_rfm2)

#Evaluate variable importance
randomForest::importance(RALU_rfm2)
varImpPlot(RALU_rfm2)

# Reduce to x variables:
# 
RALU_rfm3 <-randomForest(PA~LC+Rough+MAT+SA+elev+MCMT, data=RALU_data)

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)

system.time({
RALU_montane_mod <- predict(Sprasts_montane, RALU_rfm3)
})
stopCluster(my.cluster)

writeRaster(RALU_montane_mod,paste0(here("Outputs","Predictions"),"/RALU_montane_RFmod_red.tif"), overwrite=TRUE)

## RALU - Boreal
# Start RALU - True Record
RALU_1km$ID <- RALU_pres$ID
RALU_1km_boreal <- crop(terra::project(RALU_1km,"EPSG:32610"), Boreal)

# Extract the median values - True Records
Boreal_RALU_T <- terra::extract(Sprasts_boreal,
             fun="median",
             method="bilinear",
             RALU_1km_boreal,
             na.rm=TRUE)

RALU_1km_boreal$ID <- paste0("T",Boreal_RALU_T$ID)
Boreal_RALU_T$ID <- RALU_1km_boreal$ID
RALU_1km_boreal <- RALU_1km_boreal[,85]
Boreal_RALU_T$PA <- 1

# Pseudo RALU
RALU_Pseudo1_1km <- terra::project(RALU_Pseudo1_1km, Boreal)
RALU_F_1km_boreal <- crop(RALU_Pseudo1_1km, Boreal)

RALU_F_1km_boreal$ID <- RALU_Pseudo1$ID
RALU_F_1km_boreal <- crop(RALU_Pseudo1_1km, Boreal)

# Extract the median values - Pseudo Records
Boreal_RALU_F <- terra::extract(Sprasts_boreal,
             fun="median",
             method="bilinear",
             RALU_F_1km_boreal,
             na.rm=FALSE)

Boreal_RALU_F$ID <- RALU_F_1km_boreal$ID
Boreal_RALU_F$PA <- 0

Boreal_RALU_T2 <- merge(Boreal_RALU_T,RALU_pres,by=c("ID","PA"))
Boreal_RALU_F2 <- merge(Boreal_RALU_F,RALU_abs,by=c("ID","PA"))

RALU_data <- rbind(Boreal_RALU_T2,Boreal_RALU_F2)
RALU_data <- na.omit(RALU_data)

names(RALU_data) <- c("ID", "PA", "elev", "Rough", "SA", "NDVI", "LC", "MAT", "MCMT", "lat", "lon")
names(Sprasts_boreal) <- c("elev","Rough","SA","NDVI","LC","MAT","MCMT")
RALU_data$PA <- as.numeric(RALU_data$PA)

## RALU ----
RALU_rfm <- randomForest(formula=PA ~ elev + Rough + SA + NDVI + LC + MAT + MCMT, data=RALU_data)

randomForest::importance(RALU_rfm)
varImpPlot(RALU_rfm)
result <- rfcv(RALU_data[,c(3:9)],RALU_data$PA,scale="log",step=0.7)
with(result, plot(n.var, error.cv, log="x", type="o", lwd=2))

print(RALU_rfm)
floor(sqrt(ncol(RALU_data) - 1))

RALU_rfmtry <- tuneRF(RALU_data[-1],RALU_data$PA, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- RALU_rfmtry[RALU_rfmtry[, 2] == min(RALU_rfmtry[, 2]), 1]
print(RALU_rfmtry)

set.seed(71)
RALU_rfm2 <-randomForest(PA~.,data=RALU_data[,c(2:9)], mtry=best.m, importance=TRUE,ntree=500)
print(RALU_rfm2)

#Evaluate variable importance
randomForest::importance(RALU_rfm2)
varImpPlot(RALU_rfm2)

# Reduce to x variables:
# 
RALU_rfm3 <-randomForest(PA~elev+MCMT+LC+Rough+SA, data=RALU_data)
print(RALU_rfm3)

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)

system.time({
RALU_boreal_mod <- predict(Sprasts_boreal, RALU_rfm3)
})
stopCluster(my.cluster)

writeRaster(RALU_boreal_mod,paste0(here("Outputs","Predictions"),"/RALU_boreal_RFmod_red.tif"), overwrite=TRUE)

## RASY
# Start RASY - True Record
RASY_1km$ID <- paste0("T",RASY_pres$ID)
RASY_1km_montane <- crop(terra::project(RASY_1km,"EPSG:32610"), Montane)

# Extract the median values - True Records
Montane_RASY_T <- terra::extract(Sprasts_montane,
             fun="median",
             method="bilinear",
             RASY_1km_montane,
             na.rm=TRUE)

RASY_1km_montane$ID <- paste0("T",Montane_RASY_T$ID)
Montane_RASY_T$ID <- RASY_1km_montane$ID
RASY_1km_montane <- RASY_1km_montane[,85]
Montane_RASY_T$PA <- 1

# Pseudo RASY
RASY_Pseudo1_1km <- terra::project(RASY_Pseudo1_1km, Montane)
RASY_F_1km_montane <- crop(RASY_Pseudo1_1km, Montane)

RASY_F_1km_montane$ID <- RASY_Pseudo1$ID
RASY_F_1km_montane <- crop(RASY_Pseudo1_1km, Montane)


# Extract the median values - Pseudo Records
Montane_RASY_F <- terra::extract(Sprasts_montane,
             fun="median",
             method="bilinear",
             RASY_F_1km_montane,
             na.rm=FALSE)

Montane_RASY_F$ID <- RASY_F_1km_montane$ID
Montane_RASY_F$PA <- 0

Montane_RASY_T2 <- merge(Montane_RASY_T,RASY_pres,by=c("ID","PA"))
Montane_RASY_F2 <- merge(Montane_RASY_F,RASY_abs,by=c("ID","PA"))

RASY_data <- rbind(Montane_RASY_T2,Montane_RASY_F2)
RASY_data <- na.omit(RASY_data)
names(RASY_data) <- c("ID", "PA", "elev", "Rough", "SA", "NDVI", "LC", "MAT", "MCMT", "lat", "lon")
names(Sprasts_montane) <- c("elev","Rough","SA","NDVI","LC","MAT","MCMT")
RASY_data$PA <- as.numeric(RASY_data$PA)

## RASY ----
RASY_rfm <- randomForest(formula=PA ~ elev + Rough + SA + NDVI + LC + MAT + MCMT, data=RASY_data)

result <- rfcv(RASY_data[,c(3:9)],RASY_data$PA,scale="log",step=0.7)
with(result, plot(n.var, error.cv, log="x", type="o", lwd=2))

print(RASY_rfm)
floor(sqrt(ncol(RASY_data) - 1))

RASY_rfmtry <- tuneRF(RASY_data[-1],RASY_data$PA, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- RASY_rfmtry[RASY_rfmtry[, 2] == min(RASY_rfmtry[, 2]), 1]
print(RASY_rfmtry)

set.seed(71)
RASY_rfm2 <-randomForest(PA~.,data=RASY_data[,c(2:9)], mtry=best.m, importance=TRUE,ntree=500)
print(RASY_rfm2)

#Evaluate variable importance
randomForest::importance(RASY_rfm2)
varImpPlot(RASY_rfm2)

# Reduce to x variables:
# LC and MCMT
RASY_rfm3 <-randomForest(PA~MAT+MCMT+Rough+elev, data=RASY_data)
print(RASY_rfm3)

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)

system.time({
RASY_montane_mod <- predict(Sprasts_montane, RASY_rfm3)
})
stopCluster(my.cluster)

writeRaster(RASY_montane_mod,paste0(here("Outputs","Predictions"),"/RASY_montane_RFmod_red.tif"), overwrite=TRUE)

## RASY - Boreal
# Start RASY - True Record
RASY_1km$ID <- paste0("T",RASY_pres$ID)
RASY_1km_boreal <- crop(terra::project(RASY_1km,"EPSG:32610"), Boreal)

# Extract the median values - True Records
Boreal_RASY_T <- terra::extract(Sprasts_boreal,
             fun="median",
             method="bilinear",
             RASY_1km_boreal,
             na.rm=TRUE)

RASY_1km_boreal$ID <- paste0("T",Boreal_RASY_T$ID)
Boreal_RASY_T$ID <- RASY_1km_boreal$ID
RASY_1km_boreal <- RASY_1km_boreal[,85]
Boreal_RASY_T$PA <- 1

# Pseudo RASY
RASY_Pseudo1_1km <- terra::project(RASY_Pseudo1_1km, Boreal)
RASY_F_1km_boreal <- crop(RASY_Pseudo1_1km, Boreal)

RASY_F_1km_boreal$ID <- RASY_Pseudo1$ID
RASY_F_1km_boreal <- crop(RASY_Pseudo1_1km, Boreal)

# Extract the median values - Pseudo Records
Boreal_RASY_F <- terra::extract(Sprasts_boreal,
             fun="median",
             method="bilinear",
             RASY_F_1km_boreal,
             na.rm=FALSE)

Boreal_RASY_F$ID <- RASY_F_1km_boreal$ID
Boreal_RASY_F$PA <- 0

Boreal_RASY_T2 <- merge(Boreal_RASY_T,RASY_pres,by=c("ID","PA"))
Boreal_RASY_F2 <- merge(Boreal_RASY_F,RASY_abs,by=c("ID","PA"))

RASY_data <- rbind(Boreal_RASY_T2,Boreal_RASY_F2)
RASY_data <- na.omit(RASY_data)

names(RASY_data) <- c("ID", "PA", "elev", "Rough", "SA", "NDVI", "LC", "MAT", "MCMT", "lat", "lon")
names(Sprasts_boreal) <- c("elev","Rough","SA","NDVI","LC","MAT","MCMT")
RASY_data$PA <- as.numeric(RASY_data$PA)

## RASY ----
RASY_rfm <- randomForest(formula=PA ~ elev + Rough + SA + NDVI + LC + MAT + MCMT, data=RASY_data)

result <- rfcv(RASY_data[,c(3:9)],RASY_data$PA,scale="log",step=0.7)
with(result, plot(n.var, error.cv, log="x", type="o", lwd=2))

print(RASY_rfm)
floor(sqrt(ncol(RASY_data) - 1))

RASY_rfmtry <- tuneRF(RASY_data[-1],RASY_data$PA, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- RASY_rfmtry[RASY_rfmtry[, 2] == min(RASY_rfmtry[, 2]), 1]
print(RASY_rfmtry)

set.seed(71)
RASY_rfm2 <-randomForest(PA~.,data=RASY_data[,c(2:9)], mtry=best.m, importance=TRUE,ntree=500)
print(RASY_rfm2)

#Evaluate variable importance
randomForest::importance(RASY_rfm2)
varImpPlot(RASY_rfm2)

# Reduce to x variables:
# Nothing is really great here
RASY_rfm3 <-randomForest(PA~elev+MAT+MCMT+Rough+NDVI, data=RASY_data)
print(RASY_rfm3)

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)

system.time({
RASY_boreal_mod <- predict(Sprasts_boreal, RASY_rfm3)
})
stopCluster(my.cluster)

writeRaster(RASY_boreal_mod,paste0(here("Outputs","Predictions"),"/RASY_boreal_RFmod_red.tif"), overwrite=TRUE)

## RASY - Taiga
# Start RASY - True Record
RASY_1km$ID <- paste0("T",RASY_pres$ID)
RASY_1km_taiga <- crop(terra::project(RASY_1km,"EPSG:32610"), Taiga)

# Extract the median values - True Records
Taiga_RASY_T <- terra::extract(Sprasts_taiga,
             fun="median",
             method="bilinear",
             RASY_1km_taiga,
             na.rm=TRUE)

RASY_1km_taiga$ID <- paste0("T",Taiga_RASY_T$ID)
Taiga_RASY_T$ID <- RASY_1km_taiga$ID
RASY_1km_taiga <- RASY_1km_taiga[,85]
Taiga_RASY_T$PA <- 1

# Pseudo RASY
RASY_Pseudo1_1km <- terra::project(RASY_Pseudo1_1km, Taiga)
RASY_F_1km_taiga <- crop(RASY_Pseudo1_1km, Taiga)

RASY_F_1km_taiga$ID <- RASY_Pseudo1$ID
RASY_F_1km_taiga <- crop(RASY_Pseudo1_1km, Taiga)

# Extract the median values - Pseudo Records
Taiga_RASY_F <- terra::extract(Sprasts_taiga,
             fun="median",
             method="bilinear",
             RASY_F_1km_taiga,
             na.rm=FALSE)

Taiga_RASY_F$ID <- RASY_F_1km_taiga$ID
Taiga_RASY_F$PA <- 0

Taiga_RASY_T2 <- merge(Taiga_RASY_T,RASY_pres,by=c("ID","PA"))
Taiga_RASY_F2 <- merge(Taiga_RASY_F,RASY_abs,by=c("ID","PA"))

RASY_data <- rbind(Taiga_RASY_T2,Taiga_RASY_F2)
RASY_data <- na.omit(RASY_data)

names(RASY_data) <- c("ID", "PA", "elev", "Rough", "SA", "NDVI", "LC", "MAT", "MCMT", "lat", "lon")
names(Sprasts_taiga) <- c("elev","Rough","SA","NDVI","LC","MAT","MCMT")
RASY_data$PA <- as.numeric(RASY_data$PA)

## RASY ----
RASY_rfm <- randomForest(formula=PA ~ elev + Rough + SA + NDVI + LC + MAT + MCMT, data=RASY_data)

result <- rfcv(RASY_data[,c(3:9)],RASY_data$PA,scale="log",step=0.7)
with(result, plot(n.var, error.cv, log="x", type="o", lwd=2))

print(RASY_rfm)
floor(sqrt(ncol(RASY_data) - 1))

RASY_rfmtry <- tuneRF(RASY_data[-1],RASY_data$PA, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- RASY_rfmtry[RASY_rfmtry[, 2] == min(RASY_rfmtry[, 2]), 1]
print(RASY_rfmtry)

set.seed(71)
RASY_rfm2 <-randomForest(PA~.,data=RASY_data[,c(2:9)], mtry=best.m, importance=TRUE,ntree=500)
print(RASY_rfm2)

#Evaluate variable importance
randomForest::importance(RASY_rfm2)
varImpPlot(RASY_rfm2)

# Reduce to x variables:
# Only NDVI - too much node impurity
RASY_rfm3 <-randomForest(PA~Rough + elev + MCMT, data=RASY_data)
print(RASY_rfm3)

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)

system.time({
RASY_taiga_mod <- predict(Sprasts_taiga, RASY_rfm3)
})
stopCluster(my.cluster)

writeRaster(RASY_taiga_mod,paste0(here("Outputs","Predictions"),"/RASY_taiga_RFmod_red.tif"), overwrite=TRUE)

## AMTI - Montane
# Start AMTI - True Record
AMTI_1km$ID <- paste0("T",AMTI_pres$ID)
AMTI_1km_montane <- crop(AMTI_1km, terra::project(Montane,AMTI_1km))

# Extract the median values - True Records
Montane_AMTI_T <- terra::extract(Sprasts_montane,
             fun="median",
             method="bilinear",
             AMTI_1km_montane,
             na.rm=TRUE)

AMTI_1km_montane$ID <- paste0("T",Montane_AMTI_T$ID)
Montane_AMTI_T$ID <- AMTI_1km_montane$ID
AMTI_1km_montane <- AMTI_1km_montane[,85]
Montane_AMTI_T$PA <- 1

# Pseudo AMTI
AMTI_Pseudo1_1km <- terra::project(AMTI_Pseudo1_1km, Montane)
AMTI_F_1km_montane <- crop(AMTI_Pseudo1_1km, Montane)

AMTI_F_1km_montane$ID <- AMTI_Pseudo1$ID
AMTI_F_1km_montane <- crop(AMTI_Pseudo1_1km, Montane)

# Extract the median values - Pseudo Records
Montane_AMTI_F <- terra::extract(Sprasts_montane,
             fun="median",
             method="bilinear",
             AMTI_F_1km_montane,
             na.rm=FALSE)

Montane_AMTI_F$ID <- AMTI_F_1km_montane$ID
Montane_AMTI_F$PA <- 0

Montane_AMTI_T2 <- merge(Montane_AMTI_T,AMTI_pres,by=c("ID","PA"))
Montane_AMTI_F2 <- merge(Montane_AMTI_F,AMTI_abs,by=c("ID","PA"))

AMTI_data <- rbind(Montane_AMTI_T2,Montane_AMTI_F2)
AMTI_data <- na.omit(AMTI_data)

names(AMTI_data) <- c("ID", "PA", "elev", "Rough", "SA", "NDVI", "LC", "MAT", "MCMT", "lat", "lon")
names(Sprasts_montane) <- c("elev","Rough","SA","NDVI","LC","MAT","MCMT")
AMTI_data$PA <- as.numeric(AMTI_data$PA)

dim(AMTI_data)

## AMTI ----
AMTI_rfm <- randomForest(formula=PA ~ elev + Rough + SA + NDVI + LC + MAT + MCMT, data=AMTI_data)

result <- rfcv(AMTI_data[,c(3:9)],AMTI_data$PA,scale="log",step=0.7)
with(result, plot(n.var, error.cv, log="x", type="o", lwd=2))

print(AMTI_rfm)
floor(sqrt(ncol(AMTI_data) - 1))

AMTI_rfmtry <- tuneRF(AMTI_data[-1],AMTI_data$PA, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- AMTI_rfmtry[AMTI_rfmtry[, 2] == min(AMTI_rfmtry[, 2]), 1]
print(AMTI_rfmtry)

set.seed(71)
AMTI_rfm2 <-randomForest(PA~.,data=AMTI_data[,c(2:9)], mtry=best.m, importance=TRUE,ntree=500)
print(AMTI_rfm2)

#Evaluate variable importance
randomForest::importance(AMTI_rfm2)
varImpPlot(AMTI_rfm2)

# Reduce to x variables:
# All but SA or LC
AMTI_rfm3 <-randomForest(PA~MAT+elev+LC, data=AMTI_data)
print(AMTI_rfm3)

my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
  )

#register it to be used by %dopar%
doParallel::registerDoParallel(cl = my.cluster)

system.time({
AMTI_montane_mod <- predict(Sprasts_montane, AMTI_rfm3)
})
stopCluster(my.cluster)

writeRaster(AMTI_montane_mod,paste0(here("Outputs","Predictions"),"/AMTI_montane_RFmod_red.tif"), overwrite=TRUE)

```

# Mapping the Full SDMs

```{r mapping, echo=FALSE, eval=FALSE}

AMMA_boreal_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/AMMA_boreal_RFmod.tif"))
AMMA_montane_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/AMMA_montane_RFmod.tif"))

AMMA_RFmod <- merge(AMMA_boreal_RFmod,AMMA_montane_RFmod)

ANBO_boreal_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/ANBO_boreal_RFmod.tif"))
ANBO_montane_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/ANBO_montane_RFmod.tif"))
ANBO_RFmod <- merge(ANBO_boreal_RFmod,ANBO_montane_RFmod)

RALU_boreal_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/RALU_boreal_RFmod.tif"))
RALU_montane_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/RALU_montane_RFmod.tif"))
RALU_RFmod <- merge(RALU_boreal_RFmod,RALU_montane_RFmod)

RASY_boreal_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/RASY_boreal_RFmod.tif"))
RASY_montane_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/RASY_montane_RFmod.tif"))
RASY_RFmod1 <- merge(RASY_boreal_RFmod,RASY_montane_RFmod)

RASY_taiga_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/RASY_taiga_RFmod.tif"))
RASY_RFmod <- merge(RASY_RFmod1,RASY_taiga_RFmod)

AMTI_montane_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/AMTI_montane_RFmod.tif"))

Rough_dem <- rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/Rough_dem.tif"))

#AMMA
AMMA_map <- tm_shape(AMMA_RFmod) +
  tm_raster(style = "cont", palette = "RdYlGn",
            title = "AMMA SDM") +
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.50, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2)

#ANBO
ANBO_map <- tm_shape(ANBO_RFmod) +
  tm_raster(style = "cont", palette = "RdYlGn",
            title = "ANBO SDM") +
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.50, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2)

#RALU
RALU_map <- tm_shape(RALU_RFmod) +
  tm_raster(style = "cont", palette = "RdYlGn",
            title = "RALU SDM")+
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.50, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2)

#RASY
RASY_map <- tm_shape(RASY_RFmod) +
  tm_raster(style = "cont", palette = "RdYlGn",
            title = "RASY SDM")+
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.50, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Taiga))+
tm_borders(lwd=2)

#AMTI
AMTI_map <- tm_shape(AMTI_montane_RFmod) +
  tm_raster(style = "cont", palette = "RdYlGn",
            title = "AMTI SDM")+
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.50, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) 

AMTI_montane_RFmod2 <- AMTI_montane_RFmod
as.numeric(AMTI_montane_RFmod2)

m <- c(0, 0.85, NA,  
       0.85, 1, 1)
rclmat <- matrix(m, ncol=3, byrow=TRUE)
AMTI_montane_RFmod2 <- classify(AMTI_montane_RFmod2, rclmat, include.lowest=TRUE)
       
#AMTI >0.9 only
AMTI_map2 <- tm_shape(AMTI_montane_RFmod2) +
  tm_raster(style = "equal",
            title = "AMTI SDM", palette="green4") +
tm_layout(legend.show=FALSE) +
  tm_layout(title = "AMTI (>0.95)", title.position=c(0.60, .95)) +
tm_compass(type="arrow", position=c(0.03, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) +  tm_shape(st_as_sf(AMTI)) + tm_symbols(shape = 20, size=0.1, col="red")



## Explanatory Raster Maps

CDEM_Total <- rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/CDEM_Total.tif"))

SA_dem <- rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/SA_dem.tif"))

Boreal_MAT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Boreal_MAT.tif"))
Montane_MAT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Montane_MAT.tif"))
Taiga_MAT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Taiga_MAT.tif"))

MAT_Total <- merge(Boreal_MAT, Montane_MAT, Taiga_MAT)

LandCov <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/LandCov.tif"))

Boreal_MCMT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Boreal_MCMT.tif"))

Montane_MCMT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Montane_MCMT.tif"))

Taiga_MCMT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Taiga_MCMT.tif"))


MCMT_Total <- merge(Boreal_MCMT, Montane_MCMT, Taiga_MCMT)

# CDEM
CDEM_map <- tm_shape(CDEM_Total) +
  tm_raster(style = "cont", palette = terrain.colors(20),
            title = "CDEM Elevation (m)")+
tm_layout(legend.outside = FALSE) +
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.03, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Taiga))+
tm_borders(lwd=2)

# Modis EVI
EVI_map <- tm_shape(NDVI) +
  tm_raster(style = "cont", palette = "YlGn",
            title = "EVI: Modis 16-day")+
tm_layout(legend.outside = FALSE) +
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.03, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Taiga))+
tm_borders(lwd=2)

# Roughness
Rough_dem <- rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/Rough_dem.tif"))

Roughness_map <- tm_shape(Rough_dem) +
  tm_raster(style = "cont", palette = "BrBG") +
tm_layout(legend.show=FALSE) +
  tm_layout(title = "Roughness", title.position=c(0.60, .95)) +
tm_compass(type="arrow", position=c(0.03, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Taiga))+
tm_borders(lwd=2)

# MAT
MAT_Map <- tm_shape(MAT_Total) +
  tm_raster(style = "cont", palette = "-RdBu",
            title = "Mean Annual Temperature")+
tm_layout(legend.outside = FALSE) +
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.03, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Taiga))+
tm_borders(lwd=2)

# MCMT
MCMT_Map <- tm_shape(MCMT_Total) +
  tm_raster(style = "cont", palette = "-GnBu",
            title = "Mean Coldest Month Temperature")+
tm_layout(legend.outside = FALSE) +
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.03, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Taiga))+
tm_borders(lwd=2)

# Slope aspect
SA_Map <- tm_shape(SA_dem) +
  tm_raster(style = "cont", palette = "-viridis",
            title = "Slope * Aspect")+
tm_layout(legend.outside = FALSE) +
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.03, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Taiga))+
tm_borders(lwd=2)



```



# Mapping the Reduced SDMs

```{r mapping, echo=FALSE, eval=FALSE}

AMMA_boreal_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/AMMA_boreal_RFmod_red.tif"))
AMMA_montane_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/AMMA_montane_RFmod_red.tif"))

AMMA_RFmod <- merge(AMMA_boreal_RFmod,AMMA_montane_RFmod)

ANBO_boreal_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/ANBO_boreal_RFmod_red.tif"))
ANBO_montane_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/ANBO_montane_RFmod_red.tif"))
ANBO_RFmod <- merge(ANBO_boreal_RFmod,ANBO_montane_RFmod)

RALU_boreal_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/RALU_boreal_RFmod_red.tif"))
RALU_montane_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/RALU_montane_RFmod_red.tif"))
RALU_RFmod <- merge(RALU_boreal_RFmod,RALU_montane_RFmod)

RASY_boreal_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/RASY_boreal_RFmod_red.tif"))
RASY_montane_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/RASY_montane_RFmod_red.tif"))
RASY_RFmod1 <- merge(RASY_boreal_RFmod,RASY_montane_RFmod)

RASY_taiga_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/RASY_taiga_RFmod_red.tif"))
RASY_RFmod <- merge(RASY_RFmod1,RASY_taiga_RFmod)

AMTI_montane_RFmod <- rast(paste0(here("Outputs","Predictions"),
                                 "/AMTI_montane_RFmod_red.tif"))

Rough_dem <- rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/Rough_dem.tif"))

#AMMA
AMMA_map <- tm_shape(AMMA_RFmod) +
  tm_raster(style = "cont", palette = "RdYlGn",
            title = "AMMA SDM") +
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.50, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2)

#ANBO
ANBO_map <- tm_shape(ANBO_RFmod) +
  tm_raster(style = "cont", palette = "RdYlGn",
            title = "ANBO SDM") +
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.50, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2)

#RALU
RALU_map <- tm_shape(RALU_RFmod) +
  tm_raster(style = "cont", palette = "RdYlGn",
            title = "RALU SDM")+
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.50, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2)

#RASY
RASY_map <- tm_shape(RASY_RFmod) +
  tm_raster(style = "cont", palette = "RdYlGn",
            title = "RASY SDM")+
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.50, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Taiga))+
tm_borders(lwd=2)

#AMTI
AMTI_map <- tm_shape(AMTI_montane_RFmod) +
  tm_raster(style = "cont", palette = "RdYlGn",
            title = "AMTI SDM")+
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.50, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) 

AMTI_montane_RFmod2 <- AMTI_montane_RFmod
as.numeric(AMTI_montane_RFmod2)

m <- c(0, 0.85, NA,  
       0.85, 1, 1)
rclmat <- matrix(m, ncol=3, byrow=TRUE)
AMTI_montane_RFmod2 <- classify(AMTI_montane_RFmod2, rclmat, include.lowest=TRUE)
       
#AMTI >0.9 only
AMTI_map2 <- tm_shape(AMTI_montane_RFmod2) +
  tm_raster(style = "equal",
            title = "AMTI SDM", palette="green4") +
tm_layout(legend.show=FALSE) +
  tm_layout(title = "AMTI (>0.95)", title.position=c(0.60, .95)) +
tm_compass(type="arrow", position=c(0.03, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) +  tm_shape(st_as_sf(AMTI)) + tm_symbols(shape = 20, size=0.1, col="red")



## Explanatory Raster Maps

SA_dem <- rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/SA_dem.tif"))


LandCov <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/LandCov.tif"))


# CDEM
CDEM_Total <- rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/CDEM_Total.tif"))

CDEM_map <- tm_shape(CDEM_Total) +
  tm_raster(style = "cont", palette = terrain.colors(20),
            title = "CDEM Elevation (m)")+
tm_layout(legend.outside = FALSE) +
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.03, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Taiga))+
tm_borders(lwd=2)

# Modis EVI
NDVI <- rast(paste0(here("Inputs",
                        "Rasters",
                        "Explanatory"),
                   "/NDVI.tif"))


EVI_map <- tm_shape(NDVI) +
  tm_raster(style = "cont", palette = "YlGn",
            title = "EVI: Modis 16-day")+
tm_layout(legend.outside = FALSE) +
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.03, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Taiga))+
tm_borders(lwd=2)

# Roughness
Rough_dem <- rast(paste0(here("Inputs","Rasters",
                        "Explanatory"),"/Rough_dem.tif"))

Roughness_map <- tm_shape(Rough_dem) +
  tm_raster(style = "cont", palette = "BrBG") +
tm_layout(legend.show=FALSE) +
  tm_layout(title = "Roughness", title.position=c(0.60, .95)) +
tm_compass(type="arrow", position=c(0.03, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Taiga))+
tm_borders(lwd=2)

# MAT

Boreal_MAT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Boreal_MAT.tif"))
Montane_MAT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Montane_MAT.tif"))
Taiga_MAT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Taiga_MAT.tif"))

MAT_Total <- merge(Boreal_MAT, Montane_MAT, Taiga_MAT)

MAT_Map <- tm_shape(MAT_Total) +
  tm_raster(style = "cont", palette = "-RdBu",
            title = "Mean Annual Temperature")+
tm_layout(legend.outside = FALSE) +
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.03, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Taiga))+
tm_borders(lwd=2)

# MCMT
Boreal_MCMT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Boreal_MCMT.tif"))

Montane_MCMT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Montane_MCMT.tif"))

Taiga_MCMT <- rast(paste0(here::here("Inputs",
                                  "Rasters",
                                  "Explanatory"),
                                     "/Taiga_MCMT.tif"))


MCMT_Total <- merge(Boreal_MCMT, Montane_MCMT, Taiga_MCMT)

MCMT_Map <- tm_shape(MCMT_Total) +
  tm_raster(style = "cont", palette = "-GnBu",
            title = "Mean Coldest Month Temperature")+
tm_layout(legend.outside = FALSE) +
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.03, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Taiga))+
tm_borders(lwd=2)

# Slope aspect

SA_Map <- tm_shape(SA_dem) +
  tm_raster(style = "cont", palette = "-viridis",
            title = "Slope * Aspect")+
tm_layout(legend.outside = FALSE) +
tm_layout(legend.position= c("right", "top")) +
tm_compass(type="arrow", position=c(0.03, 0.80))+
tm_scale_bar(position = c(0.05, .02), text.size=.8) + tm_shape(st_as_sf(Montane))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Boreal))+
tm_borders(lwd=2) + tm_shape(st_as_sf(Taiga))+
tm_borders(lwd=2)

tmap_save(AMMA_map, filename = paste0(here("Outputs","Figures"),"/ABx(x)_Ch 3_Figx.x_AMMA_3.jpeg"), height = 8.27, width = 11.69, dpi=600)
          
tmap_save(ANBO_map, filename = paste0(here("Outputs","Figures"),"/ABx(x)_Ch 3_Figx.x_ANBO_3.jpeg"),height = 8.27, width = 11.69, dpi=600)
          
tmap_save(RALU_map, filename = paste0(here("Outputs","Figures"),"/ABx(x)_Ch 3_Figx.x_RALU_3.jpeg"),height = 8.27, width = 11.69, dpi=600)
          
tmap_save(RASY_map, filename = paste0(here("Outputs","Figures"),"/ABx(x)_Ch 3_Figx.x_RASY_3.jpeg"),height = 8.27, width = 11.69, dpi=600)
          
tmap_save(AMTI_map, filename = paste0(here("Outputs","Figures"),"/ABx(x)_Ch 3_Figx.x_AMTI_3.jpeg"),height = 8.27, width = 11.69, dpi=600)

tmap_save(EVI_map, filename = paste0(here("Outputs","Figures"),"/ABx(x)_Ch 3_Figx.x_EVI_3.jpeg"),height = 8.27, width = 11.69, dpi=600)

tmap_save(MAT_Map, filename = paste0(here("Outputs","Figures"),"/ABx(x)_Ch 3_Figx.x_MAT_3.jpeg"),height = 8.27, width = 11.69, dpi=600)

tmap_save(Roughness_map, filename = paste0(here("Outputs","Figures"),"/ABx(x)_Ch 3_Figx.x_Rough_3.jpeg"),height = 8.27, width = 11.69, dpi=600)


# Mapping with points

# All pts:

AMMA <- vect(paste0(here("Inputs","AmphibianLocations"),"/AMMA_Total.shp"))
AMMA <- terra::project(AMMA,crs(AMMA_RFmod))
AMTI <- vect(paste0(here("Inputs","AmphibianLocations"),"/AMTI_Total.shp"))
AMTI <- terra::project(AMTI,crs(AMTI_montane_RFmod))
ANBO <- vect(paste0(here("Inputs","AmphibianLocations"),"/ANBO_Total.shp"))
ANBO <- terra::project(ANBO,crs(ANBO_RFmod))
RALU <- vect(paste0(here("Inputs","AmphibianLocations"),"/RALU_Total.shp"))
RALU <- terra::project(RALU,crs(RALU_RFmod))
RASY <- vect(paste0(here("Inputs","AmphibianLocations"),"/RASY_Total.shp"))
RASY <- terra::project(RASY,crs(RASY_RFmod))

# Thinned - AMTI not done, too few

AMMA_thin_pts <- vect(AMMAgt_pt_s)
crs(AMMA_thin_pts) <- "epsg:4326"
AMMA_thin_pts <- terra::project(AMMA_thin_pts,crs(AMMA_RFmod))

ANBO_thin_pts <- vect(ANBOgt_pt_s)
crs(ANBO_thin_pts) <- "epsg:4326"
ANBO_thin_pts <- terra::project(ANBO_thin_pts,crs(ANBO_RFmod))

RALU_thin_pts <- vect(RALUgt_pt_s)
crs(RALU_thin_pts) <- "epsg:4326"
RALU_thin_pts <- terra::project(RALU_thin_pts,crs(RALU_RFmod))
RALU_thin_pts <- crop(RALU_thin_pts,terra::project(EcoZone,"epsg:32610"))


RASY_thin_pts <- vect(RASYgt_pt_s)
crs(RASY_thin_pts) <- "epsg:4326"
RASY_thin_pts <- terra::project(RASY_thin_pts,crs(RASY_RFmod))
RASY_thin_pts <- crop(RASY_thin_pts,terra::project(EcoZone,"epsg:32610"))

EcoZone <- terra::project(EcoZone, crs(AMMA_RFmod))

Boreal <- EcoZone[1] # Boreal
Montane <- EcoZone[2] # Montane
Taiga <- EcoZone[3] # Taiga

Boreal_Montane <- terra::union(Boreal,Montane)

# MaxEnt
AMMA_clim <- rast(paste0(here("Inputs","Rasters","MaxEnt"),
                         "/Ambystoma_macrodactylum_climate.asc"))
crs(AMMA_clim) <- "ESRI:102008"
AMMA_clim <- terra::project(AMMA_clim, crs(AMMA_RFmod))
AMMA_clim <- terra::mask(AMMA_clim,Boreal_Montane)
AMMA_clim <- terra::crop(AMMA_clim,Boreal_Montane)

ANBO_clim <- rast(paste0(here("Inputs","Rasters","MaxEnt"),
                         "/Anaxyrus_boreas_climate.asc"))
crs(ANBO_clim) <- "ESRI:102008"
ANBO_clim <- terra::project(ANBO_clim, crs(ANBO_RFmod))
ANBO_clim <- terra::mask(ANBO_clim,Boreal_Montane)
ANBO_clim <- terra::crop(ANBO_clim,Boreal_Montane)

RASY_clim <- rast(paste0(here("Inputs","Rasters","MaxEnt"),
                         "/Rana_sylvatica_climate.asc"))
crs(RASY_clim) <- "ESRI:102008"
RASY_clim <- terra::project(RASY_clim, crs(RASY_RFmod))
RASY_clim <- terra::mask(RASY_clim,EcoZone)
RASY_clim <- terra::crop(RASY_clim,EcoZone)

RALU_clim <- rast(paste0(here("Inputs","Rasters","MaxEnt"),
                         "/Rana_luteiventris_climate.asc"))
crs(RALU_clim) <- "ESRI:102008"
RALU_clim <- terra::project(RALU_clim, crs(RALU_RFmod))
RALU_clim <- terra::mask(RALU_clim,Boreal_Montane)
RALU_clim <- terra::crop(RALU_clim,Boreal_Montane)

writeRaster(AMMA_clim,
            paste0(here("Inputs","Rasters","MaxEnt"),"/AMMA_climate.tif"),
            overwrite=TRUE)
writeRaster(ANBO_clim,
            paste0(here("Inputs","Rasters","MaxEnt"),"/ANBO_climate.tif"),
            overwrite=TRUE)
writeRaster(RALU_clim,
            paste0(here("Inputs","Rasters","MaxEnt"),"/RALU_climate.tif"),
            overwrite=TRUE)
writeRaster(RASY_clim,
            paste0(here("Inputs","Rasters","MaxEnt"),"/RASY_climate.tif"),
            overwrite=TRUE)
            
            
## Mapping it together

AMMA_map2 <- tm_shape(AMMA_RFmod) +
  tm_raster(style = "cont", palette = "RdYlGn") +
  tm_layout(legend.show= FALSE, title="AMMA") +
  tm_shape(st_as_sf(Boreal_Montane)) +
  tm_borders(lwd=2)

AMMA_clim_map <- tm_shape(AMMA_clim) +
  tm_raster(style = "cont", palette = "RdYlGn") +
  tm_layout(legend.show= FALSE) +
  tm_shape(st_as_sf(Boreal_Montane)) +
  tm_borders(lwd=2)

AMMA_point_map <-  tm_shape(st_as_sf(Boreal_Montane)) +
  tm_borders(lwd=2) +
  tm_shape(st_as_sf(AMMA_thin_pts)) +
  tm_symbols(size = 0.1, shape=21) +
  tm_layout(legend.show= FALSE) 

#current.mode <- tmap_mode("plot")
AMMA_comp <- tmap_arrange(AMMA_map2, AMMA_point_map, AMMA_clim_map)
#tmap_mode(current.mode)


# ANBO

ANBO_map2 <- tm_shape(ANBO_RFmod) +
  tm_raster(style = "cont", palette = "RdYlGn") +
  tm_layout(legend.show= FALSE, title="ANBO") +
  tm_shape(st_as_sf(Boreal_Montane)) +
  tm_borders(lwd=2)

ANBO_clim_map <- tm_shape(ANBO_clim) +
  tm_raster(style = "cont", palette = "RdYlGn") +
  tm_layout(legend.show= FALSE) +
  tm_shape(st_as_sf(Boreal_Montane)) +
  tm_borders(lwd=2)

ANBO_point_map <-  tm_shape(st_as_sf(Boreal_Montane)) +
  tm_borders(lwd=2) +
  tm_shape(st_as_sf(ANBO_thin_pts)) +
  tm_symbols(size = 0.1, shape=21) +
  tm_layout(legend.show= FALSE) 

#current.mode <- tmap_mode("plot")
ANBO_comp <- tmap_arrange(ANBO_map2, ANBO_point_map, ANBO_clim_map)
#tmap_mode(current.mode)

# RASY

RASY_map2 <- tm_shape(RASY_RFmod) +
  tm_raster(style = "cont", palette = "RdYlGn") +
  tm_layout(legend.show= FALSE, title="RASY") +
  tm_shape(st_as_sf(EcoZone)) +
  tm_borders(lwd=2)

RASY_clim_map <- tm_shape(RASY_clim) +
  tm_raster(style = "cont", palette = "RdYlGn") +
  tm_layout(legend.show= FALSE) +
  tm_shape(st_as_sf(EcoZone)) +
  tm_borders(lwd=2)

RASY_point_map <-  tm_shape(st_as_sf(EcoZone)) +
  tm_borders(lwd=2) +
  tm_shape(st_as_sf(RASY_thin_pts)) +
  tm_symbols(size = 0.1, shape=21) +
  tm_layout(legend.show= FALSE) 

#current.mode <- tmap_mode("plot")
RASY_comp <- tmap_arrange(RASY_map2, RASY_point_map, RASY_clim_map)
#tmap_mode(current.mode)

# RALU

RALU_map2 <- tm_shape(RALU_RFmod) +
  tm_raster(style = "cont", palette = "RdYlGn") +
  tm_layout(legend.show= FALSE, title="RALU") +
  tm_shape(st_as_sf(Boreal_Montane)) +
  tm_borders(lwd=2)

RALU_clim_map <- tm_shape(RALU_clim) +
  tm_raster(style = "cont", palette = "RdYlGn") +
  tm_layout(legend.show= FALSE) +
  tm_shape(st_as_sf(Boreal_Montane)) +
  tm_borders(lwd=2)

RALU_point_map <-  tm_shape(st_as_sf(Boreal_Montane)) +
  tm_borders(lwd=2) +
  tm_shape(st_as_sf(RALU_thin_pts)) +
  tm_symbols(size = 0.1, shape=21) +
  tm_layout(legend.show= FALSE) 

#current.mode <- tmap_mode("plot")
RALU_comp <- tmap_arrange(RALU_map2, RALU_point_map, RALU_clim_map)
#tmap_mode(current.mode)

Full_maps <-  tmap_arrange(AMMA_map2, AMMA_point_map, AMMA_clim_map, ANBO_map2, ANBO_point_map, ANBO_clim_map, RALU_map2, RALU_point_map, RALU_clim_map, RASY_map2, RASY_point_map, RASY_clim_map, ncol = 3, nrow=4)

tmap_save(Full_maps, filename = paste0(here("Outputs","Figures"),"/ABx(x)_Ch 3_Figx.x_MaxEnt_comp.jpeg"),height = 8.27, width = 11.69, dpi=300)

```


